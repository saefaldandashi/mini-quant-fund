# =============================================================================
# GitHub Actions - Auto Deploy to AWS EC2
# =============================================================================
# 
# This workflow automatically deploys your code to AWS EC2 when you push to main.
#
# SETUP REQUIRED:
# 1. Go to GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions
# 2. Add these secrets:
#    - EC2_HOST: Your EC2 public IP (e.g., 54.123.45.67)
#    - EC2_SSH_KEY: The entire contents of your .pem private key file
#    - EC2_USER: Usually "ec2-user" for Amazon Linux or "ubuntu" for Ubuntu
#    - ALPACA_API_KEY: Your Alpaca API key
#    - ALPACA_SECRET_KEY: Your Alpaca secret key
#    - GEMINI_API_KEY: Your Gemini API key (optional)
#    - ALPHA_VANTAGE_API_KEY: Your Alpha Vantage API key (optional)
#
# =============================================================================

name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ALPHA_VANTAGE_API_KEY: ${{ secrets.ALPHA_VANTAGE_API_KEY }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script_stop: true
          envs: ALPACA_API_KEY,ALPACA_SECRET_KEY,GEMINI_API_KEY,ALPHA_VANTAGE_API_KEY
          script: |
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to app directory
            cd ~/mini-fund-tool
            
            # Pull latest code (force reset to remote to avoid divergence issues)
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main
            
            # Create/update .env file with secrets
            echo "ðŸ” Updating environment variables..."
            cat > .env << EOF
            ALPACA_API_KEY=$ALPACA_API_KEY
            ALPACA_SECRET_KEY=$ALPACA_SECRET_KEY
            GEMINI_API_KEY=$GEMINI_API_KEY
            ALPHA_VANTAGE_API_KEY=$ALPHA_VANTAGE_API_KEY
            EOF
            
            # Activate virtual environment
            source .venv/bin/activate
            
            # Install any new dependencies
            echo "ðŸ“¦ Installing dependencies..."
            pip install -r requirements.txt -q
            
            # Restart the service
            echo "ðŸ”„ Restarting service..."
            sudo systemctl restart quantfund
            
            # Wait for service to start
            sleep 5
            
            # Check service status
            if sudo systemctl is-active --quiet quantfund; then
              echo "âœ… Deployment successful! Service is running."
              
              # Health check
              HEALTH=$(curl -s http://localhost:5000/api/health | python3 -c "import sys,json; print(json.load(sys.stdin).get('status', 'unknown'))")
              echo "ðŸ¥ Health: $HEALTH"
            else
              echo "âŒ Service failed to start!"
              sudo journalctl -u quantfund -n 50 --no-pager
              exit 1
            fi

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Deployment to AWS EC2 completed successfully!"
          echo "ðŸŒ App URL: http://${{ secrets.EC2_HOST }}:5000"
      
      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check the logs above."
