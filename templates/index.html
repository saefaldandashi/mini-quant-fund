<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quant Fund Control Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #16161f;
            --bg-hover: #1e1e2a;
            --accent: #00e5ff;
            --accent-dim: rgba(0, 229, 255, 0.15);
            --success: #00f593;
            --danger: #ff4757;
            --warning: #ffa502;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9a;
            --text-dim: #5a5a6a;
            --border: rgba(255,255,255,0.08);
            --glow: 0 0 30px rgba(0, 229, 255, 0.15);
            --card-shadow: 0 4px 20px rgba(0,0,0,0.3);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
        }
        
        /* ========== TOAST NOTIFICATION SYSTEM ========== */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }
        
        .toast {
            padding: 14px 20px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
            backdrop-filter: blur(10px);
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border);
        }
        
        .toast.success { background: rgba(0, 245, 147, 0.15); border-color: rgba(0, 245, 147, 0.3); }
        .toast.error { background: rgba(255, 71, 87, 0.15); border-color: rgba(255, 71, 87, 0.3); }
        .toast.warning { background: rgba(255, 165, 2, 0.15); border-color: rgba(255, 165, 2, 0.3); }
        .toast.info { background: rgba(0, 229, 255, 0.15); border-color: rgba(0, 229, 255, 0.3); }
        
        .toast-icon { font-size: 1.2em; flex-shrink: 0; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; font-size: 0.9em; margin-bottom: 2px; }
        .toast-message { font-size: 0.8em; color: var(--text-secondary); }
        .toast-close { 
            cursor: pointer; 
            opacity: 0.5; 
            transition: opacity 0.2s;
            font-size: 1.1em;
        }
        .toast-close:hover { opacity: 1; }
        
        .toast.hiding { animation: slideOut 0.3s ease-in forwards; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* ========== KEYBOARD SHORTCUTS MODAL ========== */
        .shortcuts-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .shortcuts-modal.show { display: flex; }
        
        .shortcuts-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--border);
            box-shadow: var(--card-shadow);
        }
        
        .shortcuts-content h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .shortcut-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .shortcut-key {
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            border: 1px solid var(--border);
        }
        
        /* ========== CONNECTION STATUS ========== */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75em;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        .connection-status.offline .connection-dot {
            background: var(--danger);
            animation: none;
        }
        
        /* ========== SKELETON LOADERS ========== */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-hover) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text { height: 14px; margin: 8px 0; }
        .skeleton-value { height: 28px; width: 80px; }
        
        /* ========== QUICK STATS BANNER ========== */
        .quick-stats-banner {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            padding: 15px 20px;
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.05), rgba(124, 58, 237, 0.05));
            border-bottom: 1px solid var(--border);
        }
        
        .quick-stat {
            text-align: center;
            padding: 10px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .quick-stat:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }
        
        .quick-stat-label {
            font-size: 0.7em;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .quick-stat-value {
            font-size: 1.4em;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .quick-stat-change {
            font-size: 0.75em;
            margin-top: 4px;
        }
        
        /* ========== MINI CHART ========== */
        .mini-chart {
            height: 60px;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
        }
        
        .mini-chart svg {
            width: 100%;
            height: 100%;
        }
        
        .chart-line {
            fill: none;
            stroke: var(--accent);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .chart-area {
            fill: url(#chartGradient);
        }
        
        /* ========== TAB SYSTEM ========== */
        .tab-header {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .tab-btn:hover { color: var(--text-secondary); }
        .tab-btn.active { 
            color: var(--accent); 
            border-bottom-color: var(--accent);
            background: rgba(0, 229, 255, 0.05);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* ========== SEARCH INPUT ========== */
        .search-input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 15px 10px 40px;
            color: white;
            font-family: inherit;
            font-size: 0.85em;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-dim);
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-wrapper::before {
            content: 'üîç';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9em;
            opacity: 0.5;
        }
        
        /* ========== IMPROVED CARDS ========== */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-1px);
        }
        
        /* ========== POSITION BARS ========== */
        .pnl-bar {
            height: 4px;
            border-radius: 2px;
            background: var(--bg-secondary);
            overflow: hidden;
            margin-top: 4px;
        }
        
        .pnl-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        
        .pnl-bar-fill.positive { background: var(--success); }
        .pnl-bar-fill.negative { background: var(--danger); }
        
        /* ========== BETTER BUTTONS ========== */
        .action-btn {
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .action-btn:active::after {
            width: 200px;
            height: 200px;
        }
        
        /* ========== PROGRESS BAR ========== */
        .progress-bar {
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #7c3aed);
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s;
            animation: progressPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo h1 {
            font-size: 1.4em;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header-stats {
            display: flex;
            gap: 30px;
        }
        
        .header-stat {
            text-align: right;
        }
        
        .header-stat label {
            display: block;
            font-size: 0.7em;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header-stat value {
            font-size: 1.3em;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Main Layout */
        .main {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            min-height: calc(100vh - 80px);
        }
        
        /* Left Sidebar - Controls */
        .sidebar-left {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .action-btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .action-btn.primary {
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            color: white;
        }
        
        .action-btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }
        
        .action-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-btn.secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .action-btn.secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .action-btn.danger {
            background: rgba(255, 71, 87, 0.15);
            color: var(--danger);
            border: 1px solid rgba(255, 71, 87, 0.3);
        }
        
        /* Status Badge */
        .status-badge {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge.idle { background: var(--bg-card); color: var(--text-dim); }
        .status-badge.running { background: rgba(255, 165, 2, 0.15); color: var(--warning); }
        .status-badge.success { background: rgba(0, 245, 147, 0.15); color: var(--success); }
        .status-badge.error { background: rgba(255, 71, 87, 0.15); color: var(--danger); }
        
        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        /* Mini Cards in Sidebar */
        .mini-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border);
        }
        
        .mini-card h3 {
            font-size: 0.75em;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        /* Center - Main Content */
        .center {
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-header h2 span { font-size: 1.2em; }
        
        .card-body { padding: 20px; }
        
        /* Portfolio Grid */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 15px;
        }
        
        .portfolio-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .portfolio-item label {
            display: block;
            font-size: 0.7em;
            color: var(--text-dim);
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .portfolio-item value {
            font-size: 1.4em;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .portfolio-item.highlight value {
            color: var(--accent);
        }
        
        /* Positions Table */
        .positions-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .positions-table th {
            text-align: left;
            padding: 12px 15px;
            font-size: 0.7em;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }
        
        .positions-table th:not(:first-child) { text-align: right; }
        
        .positions-table td {
            padding: 12px 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            border-bottom: 1px solid var(--border);
        }
        
        .positions-table td:not(:first-child) { text-align: right; }
        
        .positions-table tr:hover { background: var(--bg-hover); }
        
        .ticker {
            font-weight: 600;
            color: var(--accent);
        }
        
        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        
        /* Macro Indices */
        .macro-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        
        .macro-item {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .macro-item label {
            display: block;
            font-size: 0.65em;
            color: var(--text-dim);
            margin-bottom: 5px;
        }
        
        .macro-item value {
            font-size: 1.1em;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Execution Log */
        .log-container {
            background: #0a0a0f;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75em;
            line-height: 1.8;
        }
        
        .log-container pre {
            padding: 15px;
            white-space: pre-wrap;
            color: var(--text-secondary);
        }
        
        /* Right Sidebar - Intelligence */
        .sidebar-right {
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            max-width: 350px;
        }
        
        .sidebar-right .insight-card {
            overflow: hidden;
            word-wrap: break-word;
        }
        
        .sidebar-right * {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .insight-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border);
        }
        
        .insight-card h3 {
            font-size: 0.8em;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-card h3 span { font-size: 1.1em; }
        
        /* LLM Reasoning */
        .llm-reasoning {
            background: linear-gradient(135deg, rgba(0, 229, 255, 0.05), rgba(124, 58, 237, 0.05));
            border: 1px solid rgba(0, 229, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
        }
        
        .llm-reasoning h3 {
            font-size: 0.8em;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .llm-reasoning p {
            font-size: 0.85em;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        /* Strategy Tags */
        .strategy-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .strategy-tag {
            background: rgba(124, 58, 237, 0.15);
            color: #a78bfa;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 500;
        }
        
        /* Debate Scores */
        .debate-scores {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .debate-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
        }
        
        .debate-score .bar {
            flex: 1;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            margin: 0 10px;
            overflow: hidden;
        }
        
        .debate-score .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #7c3aed);
            border-radius: 3px;
            transition: width 0.5s;
        }
        
        /* Sentiment Gauge */
        .sentiment-gauge {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 15px;
        }
        
        .gauge-bar {
            height: 10px;
            background: linear-gradient(90deg, var(--danger), var(--text-dim), var(--success));
            border-radius: 5px;
            position: relative;
            margin: 10px 0;
        }
        
        .gauge-marker {
            position: absolute;
            width: 4px;
            height: 18px;
            background: white;
            border-radius: 2px;
            top: -4px;
            transition: left 0.5s;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        
        .gauge-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7em;
            color: var(--text-dim);
        }
        
        /* Checkbox */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8em;
            color: var(--text-secondary);
        }
        
        .checkbox-row input {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
        }
        
        /* Input */
        input[type="number"] {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            width: 70px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
        
        /* Source Status Indicator */
        .source-status {
            color: var(--success);
            font-size: 0.8em;
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 1400px) {
            .main { grid-template-columns: 280px 1fr 300px; }
            .portfolio-grid { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (max-width: 1200px) {
            .main { grid-template-columns: 250px 1fr 280px; }
            .quick-stats-banner { grid-template-columns: repeat(3, 1fr); }
            .quick-stats-banner > :nth-child(4),
            .quick-stats-banner > :nth-child(5) { display: none; }
        }
        
        @media (max-width: 1100px) {
            .main { grid-template-columns: 1fr; }
            .sidebar-left, .sidebar-right { display: none; }
            .quick-stats-banner { grid-template-columns: repeat(5, 1fr); }
            .quick-stats-banner > :nth-child(4),
            .quick-stats-banner > :nth-child(5) { display: flex; flex-direction: column; }
            .portfolio-grid { grid-template-columns: repeat(3, 1fr); }
            .macro-grid { grid-template-columns: repeat(4, 1fr); }
        }
        
        @media (max-width: 768px) {
            .header { 
                flex-direction: column; 
                gap: 15px;
                padding: 15px;
            }
            .header-stats { 
                width: 100%; 
                justify-content: space-around;
                flex-wrap: wrap;
                gap: 15px;
            }
            .header-stat { text-align: center; }
            .quick-stats-banner { 
                grid-template-columns: repeat(2, 1fr);
                padding: 10px;
                gap: 10px;
            }
            .quick-stats-banner > :nth-child(5) { 
                grid-column: span 2; 
            }
            .portfolio-grid { grid-template-columns: repeat(2, 1fr); }
            .macro-grid { grid-template-columns: repeat(2, 1fr); }
            .center { padding: 10px; }
            .card-body { padding: 15px; }
            .positions-table th,
            .positions-table td { 
                padding: 8px 6px;
                font-size: 0.75em;
            }
            .toast-container {
                left: 10px;
                right: 10px;
                max-width: none;
            }
            .shortcuts-content {
                padding: 20px;
                margin: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 1.1em; }
            .logo-icon { width: 32px; height: 32px; font-size: 16px; }
            .quick-stats-banner { grid-template-columns: 1fr 1fr; }
            .quick-stat-value { font-size: 1.1em; }
            .quick-stat-label { font-size: 0.6em; }
            .portfolio-grid { grid-template-columns: 1fr 1fr; }
            .portfolio-item value { font-size: 1.1em; }
            /* Hide less important columns on mobile */
            .positions-table th:nth-child(3),
            .positions-table td:nth-child(3),
            .positions-table th:nth-child(4),
            .positions-table td:nth-child(4) { display: none; }
        }
        
        /* Mobile nav for sidebars */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 10px;
            z-index: 1000;
            justify-content: space-around;
        }
        
        .mobile-nav button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 10px 15px;
            color: white;
            font-family: inherit;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .mobile-nav button span { font-size: 1.3em; }
        
        @media (max-width: 1100px) {
            .mobile-nav { display: flex; }
            body { padding-bottom: 80px; }
        }
        
        /* Slide-in panels for mobile */
        .mobile-panel {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 85%;
            max-width: 350px;
            background: var(--bg-secondary);
            z-index: 1001;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            padding: 20px;
        }
        
        .mobile-panel.right {
            right: 0;
            left: auto;
            transform: translateX(100%);
        }
        
        .mobile-panel.show { transform: translateX(0); }
        
        .mobile-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: none;
        }
        
        .mobile-panel-overlay.show { display: block; }
        
        /* Fix overflow issues */
        .card { overflow: hidden; }
        .card-body { overflow-x: auto; }
        
        /* Better scrollbars */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
        
        /* Sortable columns */
        .sortable { 
            cursor: pointer; 
            user-select: none;
            transition: color 0.2s;
        }
        .sortable:hover { color: var(--accent); }
        .sortable.asc::after { content: ' ‚Üë'; color: var(--accent); }
        .sortable.desc::after { content: ' ‚Üì'; color: var(--accent); }
        
        /* News filter */
        .news-filter-row {
            display: flex;
            gap: 8px;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        
        .news-filter-btn {
            padding: 5px 12px;
            font-size: 0.75em;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .news-filter-btn:hover,
        .news-filter-btn.active {
            background: var(--accent-dim);
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* Improved execution log */
        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.85em;
        }
        
        .log-entry.info { color: var(--text-secondary); }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.warning { color: var(--warning); }
        
        /* Stat cards hover effect */
        .portfolio-item:hover,
        .macro-item:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
            transition: all 0.2s;
        }
        
        /* Better focus states */
        input:focus, select:focus, button:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-dim);
        }
        
        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }
        
        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.75em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
        }
        
        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toast-container"></div>
    
    <!-- Settings Modal -->
    <div class="shortcuts-modal" id="settings-modal" onclick="if(event.target===this)this.classList.remove('show')">
        <div class="shortcuts-content" style="max-width: 550px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>‚öôÔ∏è Settings</h2>
                <button onclick="document.getElementById('settings-modal').classList.remove('show')" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">√ó</button>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Theme -->
                <div>
                    <div style="font-weight: 600; margin-bottom: 8px;">üé® Theme</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="action-btn secondary" id="theme-dark" onclick="setTheme('dark')" style="flex: 1;">Dark</button>
                        <button class="action-btn secondary" id="theme-midnight" onclick="setTheme('midnight')" style="flex: 1;">Midnight</button>
                    </div>
                </div>
                
                <!-- Auto Refresh -->
                <div>
                    <div style="font-weight: 600; margin-bottom: 8px;">üîÑ Auto Refresh Interval</div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="refresh-interval" min="5" max="60" value="15" style="flex: 1;" oninput="updateRefreshInterval(this.value)">
                        <span id="refresh-interval-label" style="min-width: 50px;">15s</span>
                    </div>
                </div>
                
                <!-- Sound Alerts -->
                <div>
                    <div style="font-weight: 600; margin-bottom: 8px;">üîî Notifications</div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="sound-alerts">
                        <label for="sound-alerts">Enable sound alerts</label>
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="toast-alerts" checked>
                        <label for="toast-alerts">Show toast notifications</label>
                    </div>
                </div>
                
                <!-- Display -->
                <div>
                    <div style="font-weight: 600; margin-bottom: 8px;">üìä Display</div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="show-pnl-bars" checked>
                        <label for="show-pnl-bars">Show P/L bars on positions</label>
                    </div>
                    <div class="checkbox-row">
                        <input type="checkbox" id="compact-view">
                        <label for="compact-view">Compact view</label>
                    </div>
                </div>
                
                <!-- Export -->
                <div>
                    <div style="font-weight: 600; margin-bottom: 8px;">üì• Export Data</div>
                    <div style="display: flex; gap: 10px;">
                        <button class="action-btn secondary" onclick="exportPositions()" style="flex: 1;">Export Positions (CSV)</button>
                        <button class="action-btn secondary" onclick="exportTrades()" style="flex: 1;">Export Trades (CSV)</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 25px; text-align: center;">
                <button class="action-btn primary" onclick="saveSettings(); document.getElementById('settings-modal').classList.remove('show');" style="padding: 12px 40px;">Save Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Leverage Details Modal -->
    <div class="shortcuts-modal" id="leverage-modal" onclick="if(event.target===this)this.classList.remove('show')">
        <div class="shortcuts-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üí∞ Leverage & Margin</h2>
                <button onclick="document.getElementById('leverage-modal').classList.remove('show')" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">√ó</button>
            </div>
            
            <div id="leverage-modal-content">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="background: var(--bg-darker); padding: 15px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.8em; margin-bottom: 5px;">Current Leverage</div>
                        <div id="lev-current" style="font-size: 1.8em; font-weight: bold; color: var(--accent);">1.0x</div>
                    </div>
                    <div style="background: var(--bg-darker); padding: 15px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.8em; margin-bottom: 5px;">Max Allowed</div>
                        <div id="lev-max" style="font-size: 1.8em; font-weight: bold; color: var(--text-primary);">2.0x</div>
                    </div>
                    <div style="background: var(--bg-darker); padding: 15px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.8em; margin-bottom: 5px;">Margin Used</div>
                        <div id="lev-margin-used" style="font-size: 1.8em; font-weight: bold;">0%</div>
                    </div>
                    <div style="background: var(--bg-darker); padding: 15px; border-radius: 8px;">
                        <div style="color: var(--text-secondary); font-size: 0.8em; margin-bottom: 5px;">Margin Buffer</div>
                        <div id="lev-margin-buffer" style="font-size: 1.8em; font-weight: bold; color: var(--green);">100%</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: var(--text-primary);">Dynamic Limits</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px 0; color: var(--text-secondary);">VIX Level</td>
                            <td id="lev-vix" style="text-align: right; padding: 10px 0;">--</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px 0; color: var(--text-secondary);">VIX-Adjusted Max</td>
                            <td id="lev-vix-max" style="text-align: right; padding: 10px 0;">--</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px 0; color: var(--text-secondary);">Drawdown</td>
                            <td id="lev-drawdown" style="text-align: right; padding: 10px 0;">--</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px 0; color: var(--text-secondary);">Drawdown-Adjusted Max</td>
                            <td id="lev-dd-max" style="text-align: right; padding: 10px 0;">--</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px 0; color: var(--text-secondary);">Buying Power</td>
                            <td id="lev-buying-power" style="text-align: right; padding: 10px 0;">--</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px 0; color: var(--text-secondary);">Daily P/L</td>
                            <td id="lev-daily-pnl" style="text-align: right; padding: 10px 0;">--</td>
                        </tr>
                    </table>
                </div>
                
                <div id="kill-switch-section" style="margin-top: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; display: none;">
                    <h3 style="color: var(--red); margin-bottom: 10px;">üö® Kill Switch Active</h3>
                    <p id="kill-switch-reason" style="color: var(--text-secondary);"></p>
                </div>
                
                <div style="margin-top: 25px; display: flex; gap: 10px; justify-content: center;">
                    <button class="action-btn secondary" onclick="loadLeverageStatus()">
                        ‚Üª Refresh
                    </button>
                    <button class="action-btn" style="background: var(--red); color: white;" onclick="toggleKillSwitch()">
                        üö® Emergency Kill Switch
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcuts-modal" onclick="if(event.target===this)this.classList.remove('show')">
        <div class="shortcuts-content">
            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
            <div class="shortcut-row">
                <span>Run Rebalancing</span>
                <span class="shortcut-key">R</span>
            </div>
            <div class="shortcut-row">
                <span>Refresh Data</span>
                <span class="shortcut-key">F</span>
            </div>
            <div class="shortcut-row">
                <span>Toggle Fast Mode</span>
                <span class="shortcut-key">Q</span>
            </div>
            <div class="shortcut-row">
                <span>Toggle Dry Run</span>
                <span class="shortcut-key">D</span>
            </div>
            <div class="shortcut-row">
                <span>Cancel Orders</span>
                <span class="shortcut-key">C</span>
            </div>
            <div class="shortcut-row">
                <span>Show/Hide Shortcuts</span>
                <span class="shortcut-key">?</span>
            </div>
            <div class="shortcut-row">
                <span>Search Positions</span>
                <span class="shortcut-key">/</span>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="action-btn secondary" onclick="document.getElementById('shortcuts-modal').classList.remove('show')" style="padding: 10px 30px;">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="logo-icon">‚ö°</div>
            <h1>Quant Fund</h1>
        </div>
        <div class="header-stats">
            <div class="header-stat">
                <label>Portfolio Value</label>
                <value id="header-equity" style="color: var(--accent);">$--</value>
            </div>
            <div class="header-stat">
                <label>Today's P/L</label>
                <value id="header-pnl">$--</value>
            </div>
            <div class="header-stat">
                <label>LLM Status</label>
                <value id="header-llm" style="color: var(--success);">‚óè</value>
            </div>
            <div class="connection-status" id="connection-status">
                <div class="connection-dot"></div>
                <span>Connected</span>
            </div>
            <button onclick="document.getElementById('shortcuts-modal').classList.add('show')" title="Keyboard Shortcuts" style="background: transparent; border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 0.85em;">
                ‚å®Ô∏è
            </button>
            <button onclick="document.getElementById('settings-modal').classList.add('show')" title="Settings" style="background: transparent; border: 1px solid var(--border); padding: 6px 10px; border-radius: 6px; color: var(--text-secondary); cursor: pointer; font-size: 0.85em;">
                ‚öôÔ∏è
            </button>
        </div>
    </header>
    
    <!-- Quick Stats Banner -->
    <div class="quick-stats-banner">
        <div class="quick-stat">
            <div class="quick-stat-label">Today</div>
            <div class="quick-stat-value" id="qs-today">$0</div>
            <div class="quick-stat-change" id="qs-today-pct">0%</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-label">This Week</div>
            <div class="quick-stat-value" id="qs-week">$0</div>
            <div class="quick-stat-change" id="qs-week-pct">0%</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-label">Win Rate</div>
            <div class="quick-stat-value" id="qs-winrate">--</div>
            <div class="quick-stat-change" id="qs-trades">0 trades</div>
        </div>
        <div class="quick-stat" id="qs-leverage-card" title="Click for leverage details">
            <div class="quick-stat-label">Leverage</div>
            <div class="quick-stat-value" id="qs-leverage">1.0x</div>
            <div class="quick-stat-change" id="qs-leverage-state">healthy</div>
        </div>
        <div class="quick-stat">
            <div class="quick-stat-label">Margin Buffer</div>
            <div class="quick-stat-value" id="qs-margin">--</div>
            <div class="quick-stat-change" id="qs-buying-power">Available</div>
        </div>
    </div>
    
    <!-- Main Layout -->
    <main class="main">
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <div id="status-badge" class="status-badge idle">
                <div class="pulse"></div>
                <span>Ready</span>
            </div>
            
            <button id="run-btn" class="action-btn primary" onclick="runRebalance()">
                <span>‚ñ∂</span> Run Rebalancing
            </button>
            
            <button class="action-btn secondary" onclick="cancelOrders()">
                Cancel All Orders
            </button>
            
            <button class="action-btn secondary" onclick="refreshData()">
                ‚Üª Refresh Data
            </button>
            
            <div class="checkbox-row">
                <input type="checkbox" id="dry-run" checked>
                <label for="dry-run">üß™ Dry Run (simulation)</label>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="force-rebalance">
                <label for="force-rebalance">Force rebalance</label>
            </div>
            
            <div class="checkbox-row">
                <input type="checkbox" id="cancel-previous" checked>
                <label for="cancel-previous">Cancel previous orders</label>
            </div>
            
            <div class="mini-card">
                <h3>‚ö° Auto Rebalance</h3>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                    <button id="auto-btn" class="action-btn secondary" onclick="toggleAuto()" style="padding: 8px 12px; font-size: 0.75em;">
                        Enable
                    </button>
                    <input type="number" id="auto-interval" value="60" min="5" style="width: 50px;">
                    <span style="font-size: 0.75em; color: var(--text-dim);">min</span>
                </div>
                <div style="margin-top: 8px; font-size: 0.7em; color: var(--text-dim);">
                    ‚úì No confirmation needed<br>
                    ‚úì Uses Fast Mode (skips LLM)
                </div>
            </div>
            
            <div class="mini-card">
                <h3>‚ö° Fast Mode</h3>
                <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                    <input type="checkbox" id="fast-mode" checked>
                    <label for="fast-mode" style="font-size: 0.8em;">Skip LLM (faster)</label>
                </div>
                <div style="margin-top: 6px; font-size: 0.65em; color: var(--text-dim);">
                    ~30-60s vs ~2-3min
                </div>
            </div>
            
            <div class="mini-card">
                <h3>‚ö° Risk Appetite</h3>
                <select id="risk-appetite" onchange="updateRiskAppetite()" style="width: 100%; padding: 8px; margin-top: 8px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 6px; color: white; font-size: 0.85em;">
                    <option value="conservative">Conservative (0.25x Kelly)</option>
                    <option value="moderate" selected>Moderate (0.50x Kelly)</option>
                    <option value="aggressive">Aggressive (0.75x Kelly)</option>
                    <option value="maximum">Maximum (1.0x Kelly)</option>
                </select>
                <div id="risk-appetite-info" style="margin-top: 8px; font-size: 0.7em; color: var(--text-dim);">
                    Min Position: 2% | Max: 20 stocks
                </div>
            </div>
            
            <div class="mini-card">
                <h3>üíµ Capital Exposure</h3>
                <div style="margin-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                        <input type="radio" name="exposure-mode" id="exposure-manual" checked onchange="toggleExposureMode()">
                        <label for="exposure-manual" style="font-size: 0.8em; color: var(--text-secondary);">Manual</label>
                        <input type="number" id="exposure-pct" value="80" min="10" max="100" style="width: 55px;">
                        <span style="font-size: 0.75em; color: var(--text-dim);">%</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" name="exposure-mode" id="exposure-auto" onchange="toggleExposureMode()">
                        <label for="exposure-auto" style="font-size: 0.8em; color: var(--text-secondary);">Auto (Risk-Based)</label>
                    </div>
                    <div id="auto-exposure-info" style="display: none; margin-top: 8px; padding: 8px; background: var(--bg-primary); border-radius: 6px; font-size: 0.75em;">
                        <div style="color: var(--text-dim);">Suggested:</div>
                        <div id="suggested-exposure" style="font-size: 1.2em; color: var(--accent);">--</div>
                    </div>
                </div>
            </div>
            
            <div class="mini-card">
                <h3>üìä Market Regime</h3>
                <div id="regime-display" style="margin-top: 8px; text-align: center;">
                    <div id="regime-label" style="font-size: 1.1em; font-weight: 600; color: var(--accent);">--</div>
                    <div id="regime-score" style="font-size: 0.75em; color: var(--text-dim);">Score: --</div>
                    <div id="regime-exposure" style="font-size: 0.75em; color: var(--text-dim);">Exposure: --</div>
                </div>
            </div>
            
            <div class="mini-card">
                <h3>Strategies</h3>
                <div class="strategy-tags" id="strategy-tags">
                    <span class="strategy-tag">Momentum</span>
                    <span class="strategy-tag">MeanRev</span>
                    <span class="strategy-tag">VolTarget</span>
                    <span class="strategy-tag">RiskParity</span>
                    <span class="strategy-tag">Sentiment</span>
                    <span class="strategy-tag">TailRisk</span>
                    <span class="strategy-tag">Carry</span>
                    <span class="strategy-tag">Value</span>
                    <span class="strategy-tag">MLEnsemble</span>
                </div>
            </div>
            
            <div class="mini-card">
                <h3>üì° Data Sources</h3>
                <div id="data-sources" style="font-size: 0.75em; color: var(--text-secondary);">
                    <div style="margin-bottom: 4px;">üìä Alpaca <span class="source-status">‚óè</span></div>
                    <div style="margin-bottom: 4px;">üì∞ Alpha Vantage <span class="source-status">‚óè</span></div>
                    <div style="margin-bottom: 4px;">üìà Yahoo Finance <span class="source-status">‚óè</span></div>
                    <div style="margin-bottom: 4px;">üèõÔ∏è FRED <span id="fred-status" class="source-status" style="color: var(--text-dim);">‚óã</span></div>
                    <div>ü§ñ Gemini <span class="source-status">‚óè</span></div>
                </div>
                <div style="margin-top: 8px; font-size: 0.65em; color: var(--text-dim);">
                    Auto-refresh: <span id="refresh-status">every 15 min</span>
                </div>
            </div>
            
            <div class="mini-card">
                <h3>üìä Live Market</h3>
                <div style="font-size: 0.75em;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">VIX</span>
                        <span id="live-vix" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">SPY</span>
                        <span id="live-spy" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">10Y Yield</span>
                        <span id="live-treasury" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">Gold</span>
                        <span id="live-gold" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">Oil (WTI)</span>
                        <span id="live-oil" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Risk Score</span>
                        <span id="live-risk" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                </div>
                <button class="action-btn secondary" onclick="refreshMarketData()" style="width: 100%; margin-top: 8px; padding: 6px; font-size: 0.7em;">
                    ‚Üª Refresh
                </button>
            </div>
            
            <!-- Economic Data Card -->
            <div class="mini-card">
                <h3>üìà Economic Data</h3>
                <div style="font-size: 0.75em; color: var(--text-dim);">From FRED API</div>
                <div style="font-size: 0.75em; margin-top: 6px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">CPI YoY</span>
                        <span id="live-cpi" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">Unemployment</span>
                        <span id="live-unemployment" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span style="color: var(--text-dim);">Fed Funds</span>
                        <span id="live-fedfunds" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Fin Stress</span>
                        <span id="live-finstress" style="font-family: 'JetBrains Mono';">--</span>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Center Content -->
        <div class="center">
            <!-- Portfolio Overview -->
            <div class="card">
                <div class="card-header">
                    <h2><span>üí∞</span> Portfolio Overview</h2>
                    <span style="font-size: 0.75em; color: var(--text-dim);" id="last-updated">--</span>
                </div>
                <div class="card-body">
                    <div class="portfolio-grid">
                        <div class="portfolio-item highlight">
                            <label>Total Equity</label>
                            <value id="total-equity">$--</value>
                        </div>
                        <div class="portfolio-item">
                            <label>Cash</label>
                            <value id="total-cash">$--</value>
                        </div>
                        <div class="portfolio-item">
                            <label>Invested</label>
                            <value id="invested">$--</value>
                        </div>
                        <div class="portfolio-item">
                            <label>P/L Today</label>
                            <value id="pnl-today">$--</value>
                        </div>
                        <div class="portfolio-item">
                            <label>P/L %</label>
                            <value id="pnl-pct">--%</value>
                        </div>
                        <div class="portfolio-item">
                            <label>Positions</label>
                            <value id="position-count">--</value>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Macro Intelligence -->
            <div class="card">
                <div class="card-header">
                    <h2><span>üåç</span> Macro Intelligence</h2>
                    <button class="action-btn secondary" onclick="refreshMacro()" style="padding: 6px 12px; font-size: 0.7em;">‚Üª Refresh</button>
                </div>
                <div class="card-body">
                    <div class="macro-grid">
                        <div class="macro-item" title="Based on CPI YoY + news sentiment">
                            <label>Inflation</label>
                            <value id="macro-inflation" class="neutral">0.00</value>
                        </div>
                        <div class="macro-item" title="Based on unemployment rate + news">
                            <label>Labor</label>
                            <value id="macro-labor" class="neutral">0.00</value>
                        </div>
                        <div class="macro-item" title="Based on SPY momentum + news">
                            <label>Growth</label>
                            <value id="macro-growth" class="neutral">0.00</value>
                        </div>
                        <div class="macro-item" title="Based on Fed Funds rate + news">
                            <label>CB Hawkish</label>
                            <value id="macro-cb" class="neutral">0.00</value>
                        </div>
                        <div class="macro-item" title="Based on VIX + news">
                            <label>Geo Risk</label>
                            <value id="macro-geo" class="neutral">0.00</value>
                        </div>
                        <div class="macro-item" title="FRED Financial Stress Index + news">
                            <label>Fin Stress</label>
                            <value id="macro-stress" class="neutral">0.00</value>
                        </div>
                        <div class="macro-item" title="Based on Oil price + news">
                            <label>Commodity</label>
                            <value id="macro-commodity" class="neutral">0.00</value>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 10px; color: var(--text-dim);">
                        üìä Hybrid: 60-70% real data (FRED/Yahoo) + 30-40% news sentiment
                    </div>
                    <div class="sentiment-gauge" style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 0.8em; color: var(--text-dim);">Risk Sentiment</span>
                            <span id="risk-sentiment-value" style="font-weight: 600;">Neutral</span>
                        </div>
                        <div class="gauge-bar">
                            <div id="gauge-marker" class="gauge-marker" style="left: 50%;"></div>
                        </div>
                        <div class="gauge-labels">
                            <span>Risk-Off</span>
                            <span>Neutral</span>
                            <span>Risk-On</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- News Headlines -->
            <div class="card">
                <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                    <h2><span>üì∞</span> Latest News</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="search-wrapper" style="max-width: 150px;">
                            <input type="text" class="search-input" id="news-search" placeholder="Filter..." oninput="filterNews(this.value)" style="padding: 6px 12px 6px 32px; font-size: 0.8em;">
                        </div>
                        <button class="action-btn secondary" onclick="refreshNews()" style="padding: 6px 12px; font-size: 0.7em;">‚Üª Refresh</button>
                    </div>
                </div>
                <div class="news-filter-row" id="news-ticker-filters">
                    <button class="news-filter-btn active" onclick="setNewsFilter('all')">All</button>
                    <!-- Ticker buttons will be dynamically added -->
                </div>
                <div class="card-body" style="padding: 0; max-height: 350px; overflow-y: auto;">
                    <div id="news-list" style="padding: 15px;">
                        <div style="text-align: center; color: var(--text-dim); padding: 20px;">Loading news...</div>
                    </div>
                </div>
            </div>
            
            <!-- Current Positions -->
            <div class="card">
                <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                    <h2><span>üìà</span> Positions</h2>
                    <div class="search-wrapper" style="flex: 1; max-width: 200px; min-width: 120px;">
                        <input type="text" class="search-input" id="position-search" placeholder="Search..." oninput="filterPositions(this.value)">
                    </div>
                </div>
                <div class="tab-header">
                    <button class="tab-btn active" data-tab="current" onclick="switchPositionTab('current')">Current</button>
                    <button class="tab-btn" data-tab="history" onclick="switchPositionTab('history')">Trade History</button>
                </div>
                <div class="tab-content active" id="tab-current" style="padding: 0; max-height: 350px; overflow-y: auto;">
                    <table class="positions-table sortable-table">
                        <thead>
                            <tr>
                                <th data-sort="symbol" class="sortable">Symbol ‚áÖ</th>
                                <th data-sort="qty" class="sortable">Qty ‚áÖ</th>
                                <th data-sort="avg_entry_price" class="sortable">Avg Cost ‚áÖ</th>
                                <th data-sort="current_price" class="sortable">Current ‚áÖ</th>
                                <th data-sort="market_value" class="sortable">Value ‚áÖ</th>
                                <th data-sort="unrealized_pl" class="sortable">P/L ‚áÖ</th>
                                <th data-sort="unrealized_plpc" class="sortable">P/L % ‚áÖ</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                            <tr><td colspan="7" style="text-align: center; color: var(--text-dim); padding: 30px;">Loading positions...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="tab-content" id="tab-history" style="padding: 0; max-height: 350px; overflow-y: auto;">
                    <table class="positions-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Value</th>
                                <th>P/L</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <tr><td colspan="7" style="text-align: center; color: var(--text-dim); padding: 30px;">No trade history available</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Execution Log -->
            <div class="card">
                <div class="card-header">
                    <h2><span>üìã</span> Execution Log</h2>
                    <button class="action-btn secondary" onclick="clearLog()" style="padding: 6px 12px; font-size: 0.7em;">Clear</button>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="log-container">
                        <pre id="execution-log">Waiting for rebalance...</pre>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar - Intelligence -->
        <aside class="sidebar-right">
            <!-- LLM Reasoning -->
            <div class="llm-reasoning">
                <h3><span>üß†</span> LLM Trade Reasoning</h3>
                <p id="llm-reasoning-text">Run a rebalance to see AI-generated trade reasoning...</p>
            </div>
            
            <!-- Debate Scores -->
            <div class="insight-card">
                <h3><span>‚öîÔ∏è</span> Debate Scores</h3>
                <div class="debate-scores" id="debate-scores">
                    <div class="debate-score">
                        <span style="color: var(--text-dim);">Momentum</span>
                        <div class="bar"><div class="bar-fill" style="width: 0%;"></div></div>
                        <span style="font-family: 'JetBrains Mono'; font-size: 0.8em;">--</span>
                    </div>
                    <div class="debate-score">
                        <span style="color: var(--text-dim);">MeanRev</span>
                        <div class="bar"><div class="bar-fill" style="width: 0%;"></div></div>
                        <span style="font-family: 'JetBrains Mono'; font-size: 0.8em;">--</span>
                    </div>
                    <div class="debate-score">
                        <span style="color: var(--text-dim);">Sentiment</span>
                        <div class="bar"><div class="bar-fill" style="width: 0%;"></div></div>
                        <span style="font-family: 'JetBrains Mono'; font-size: 0.8em;">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Learning System - Enhanced -->
            <div class="insight-card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 5px;">
                    <h3><span>üß†</span> Learning System</h3>
                    <span id="learning-maturity" style="font-size: 0.65em; padding: 3px 8px; border-radius: 10px; background: rgba(88, 166, 255, 0.2); color: var(--accent);">--</span>
                </div>
                
                <!-- Core Metrics Row - 2x2 grid for sidebar -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin: 12px 0;">
                    <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                        <div id="learning-trades" style="font-size: 1.2em; font-weight: bold; color: var(--accent);">--</div>
                        <div style="font-size: 0.65em; color: var(--text-dim);">Trades</div>
                    </div>
                    <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                        <div id="learning-winrate" style="font-size: 1.2em; font-weight: bold;" class="positive">--</div>
                        <div style="font-size: 0.65em; color: var(--text-dim);">Win Rate</div>
                    </div>
                    <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                        <div id="learning-patterns" style="font-size: 1.2em; font-weight: bold; color: var(--accent);">--</div>
                        <div style="font-size: 0.65em; color: var(--text-dim);">Patterns</div>
                    </div>
                    <div style="text-align: center; padding: 8px; background: var(--bg-card); border-radius: 6px;">
                        <div id="learning-pnl" style="font-size: 1.2em; font-weight: bold;">--</div>
                        <div style="font-size: 0.65em; color: var(--text-dim);">P/L</div>
                    </div>
                </div>
                
                <!-- Learning Influence Bar -->
                <div style="margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.7em; margin-bottom: 4px;">
                        <span style="color: var(--text-dim);">Influence</span>
                        <span id="learning-influence-pct" style="color: var(--accent);">--</span>
                    </div>
                    <div style="height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden;">
                        <div id="learning-influence-bar" style="height: 100%; width: 30%; background: linear-gradient(90deg, var(--accent), #3fb950); transition: width 0.5s;"></div>
                    </div>
                </div>
                
                <!-- Top/Bottom Strategies - Compact layout -->
                <div style="display: flex; flex-direction: column; gap: 8px; margin: 10px 0;">
                    <div style="padding: 8px; background: rgba(63, 185, 80, 0.1); border-radius: 6px; border-left: 2px solid #3fb950;">
                        <div style="font-size: 0.7em; color: #3fb950; margin-bottom: 4px;">üìà Top</div>
                        <div id="learning-top-strategies" style="font-size: 0.65em; color: var(--text-primary); word-wrap: break-word; overflow-wrap: break-word; line-height: 1.4;">
                            Loading...
                        </div>
                    </div>
                    <div style="padding: 8px; background: rgba(248, 81, 73, 0.1); border-radius: 6px; border-left: 2px solid #f85149;">
                        <div style="font-size: 0.7em; color: #f85149; margin-bottom: 4px;">üìâ Low</div>
                        <div id="learning-bottom-strategies" style="font-size: 0.65em; color: var(--text-primary); word-wrap: break-word; overflow-wrap: break-word; line-height: 1.4;">
                            Loading...
                        </div>
                    </div>
                </div>
                
                <!-- Active Patterns - Collapsible -->
                <details style="margin: 10px 0;">
                    <summary style="font-size: 0.7em; color: var(--accent); cursor: pointer; padding: 6px; background: var(--bg-card); border-radius: 6px;">üîç Active Patterns</summary>
                    <div id="learning-active-patterns" style="font-size: 0.65em; color: var(--text-dim); padding: 8px; max-height: 100px; overflow-y: auto;">
                        No patterns active
                    </div>
                </details>
                
                <!-- Key Insight - Compact -->
                <div id="learning-key-insight" style="margin: 10px 0; padding: 8px; background: rgba(88, 166, 255, 0.1); border-radius: 6px; border-left: 2px solid var(--accent); font-size: 0.65em; display: none;">
                    <div id="learning-insight-text" style="color: var(--text-primary);"></div>
                    <div id="learning-insight-action" style="color: #3fb950; margin-top: 4px; font-style: italic;"></div>
                </div>
                
                <!-- Action Buttons - Stacked for sidebar -->
                <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 10px;">
                    <div style="display: flex; gap: 6px;">
                        <button class="action-btn secondary" onclick="updateLearningOutcomes()" style="flex: 1; padding: 6px; font-size: 0.7em;">
                            üìä Update
                        </button>
                        <button class="action-btn secondary" onclick="viewLearningReport()" style="flex: 1; padding: 6px; font-size: 0.7em;">
                            üìã Report
                        </button>
                        <button class="action-btn secondary" onclick="downloadLearningReport()" style="padding: 6px 10px; font-size: 0.7em;">
                            ‚¨áÔ∏è
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Signal Accuracy -->
            <div class="insight-card">
                <h3><span>üéØ</span> Signal Accuracy</h3>
                <div style="font-size: 0.85em;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">1-Day Accuracy</span>
                        <span id="accuracy-1d">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">5-Day Accuracy</span>
                        <span id="accuracy-5d">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Sentiment Edge</span>
                        <span id="sentiment-edge">--</span>
                    </div>
                </div>
            </div>
            
            <!-- Execution Quality (Phase 2) -->
            <div class="insight-card">
                <h3><span>‚ö°</span> Smart Execution</h3>
                <div style="font-size: 0.85em;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">Total Orders</span>
                        <span id="exec-total">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">Limit Fill Rate</span>
                        <span id="exec-fill-rate" class="positive">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">Price Improvement</span>
                        <span id="exec-improvement" class="positive">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">Avg Spread</span>
                        <span id="exec-spread">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Symbols Tracked</span>
                        <span id="exec-symbols">--</span>
                    </div>
                </div>
                <div id="exec-insights" style="margin-top: 10px; font-size: 0.7em; color: var(--text-dim); border-top: 1px solid var(--border); padding-top: 8px;">
                    <!-- Best/worst performers will be shown here -->
                </div>
            </div>
            
            <!-- Report Generation -->
            <div class="insight-card">
                <h3><span>üìÑ</span> Reports</h3>
                <div style="font-size: 0.85em;">
                    <button class="action-btn secondary" onclick="generateReport('daily')" style="width: 100%; margin-bottom: 8px; padding: 8px; font-size: 0.8em;">
                        üìä Generate Daily Report
                    </button>
                    <button class="action-btn secondary" onclick="generateReport('weekly')" style="width: 100%; margin-bottom: 8px; padding: 8px; font-size: 0.8em;">
                        üìà Generate Weekly Report
                    </button>
                    <button class="action-btn secondary" onclick="generateReport('monthly')" style="width: 100%; margin-bottom: 8px; padding: 8px; font-size: 0.8em;">
                        üìâ Generate Monthly Report
                    </button>
                    <button class="action-btn secondary" onclick="listReports()" style="width: 100%; padding: 8px; font-size: 0.8em;">
                        üìã View Reports
                    </button>
                </div>
                <div id="report-status" style="margin-top: 10px; font-size: 0.7em; color: var(--text-dim);">
                    <!-- Report generation status -->
                </div>
            </div>
            
            <!-- Top Ticker Sentiments -->
            <div class="insight-card">
                <h3><span>üìä</span> Ticker Sentiment</h3>
                <div id="ticker-sentiments" style="font-size: 0.8em;">
                    <div style="color: var(--text-dim);">Loading...</div>
                </div>
            </div>
            
            <!-- LLM Stats -->
            <div class="insight-card">
                <h3><span>ü§ñ</span> LLM Usage</h3>
                <div style="font-size: 0.85em;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">Provider</span>
                        <span id="llm-provider">Gemini</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">Model</span>
                        <span id="llm-model">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-dim);">Calls Today</span>
                        <span id="llm-calls">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-dim);">Cache Hit %</span>
                        <span id="llm-cache">--</span>
                    </div>
                </div>
            </div>
        </aside>
    </main>
    
    <!-- Mobile Navigation -->
    <div class="mobile-panel-overlay" id="mobile-overlay" onclick="closeMobilePanel()"></div>
    
    <div class="mobile-panel" id="mobile-controls">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 1.1em;">‚ö° Controls</h3>
            <button onclick="closeMobilePanel()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">√ó</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button id="mobile-run-btn" class="action-btn primary" onclick="runRebalance(); closeMobilePanel();">
                <span>‚ñ∂</span> Run Rebalancing
            </button>
            <button class="action-btn secondary" onclick="cancelOrders(); closeMobilePanel();">
                Cancel All Orders
            </button>
            <button class="action-btn secondary" onclick="refreshData(); closeMobilePanel();">
                ‚Üª Refresh Data
            </button>
            <div class="checkbox-row" style="padding: 10px 0;">
                <input type="checkbox" id="mobile-dry-run" checked onchange="document.getElementById('dry-run').checked = this.checked">
                <label for="mobile-dry-run">üß™ Dry Run (simulation)</label>
            </div>
            <div class="checkbox-row" style="padding: 10px 0;">
                <input type="checkbox" id="mobile-fast-mode" checked onchange="document.getElementById('fast-mode').checked = this.checked">
                <label for="mobile-fast-mode">‚ö° Fast Mode</label>
            </div>
        </div>
    </div>
    
    <div class="mobile-panel right" id="mobile-intel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="font-size: 1.1em;">üß† Intelligence</h3>
            <button onclick="closeMobilePanel()" style="background: none; border: none; color: white; font-size: 1.5em; cursor: pointer;">√ó</button>
        </div>
        <div id="mobile-reasoning" style="font-size: 0.85em; color: var(--text-secondary); line-height: 1.6;">
            Run a rebalance to see AI reasoning...
        </div>
    </div>
    
    <nav class="mobile-nav">
        <button onclick="openMobilePanel('mobile-controls')">
            <span>‚ö°</span>
            Controls
        </button>
        <button onclick="runRebalance()">
            <span>‚ñ∂Ô∏è</span>
            Rebalance
        </button>
        <button onclick="refreshData()">
            <span>‚Üª</span>
            Refresh
        </button>
        <button onclick="openMobilePanel('mobile-intel')">
            <span>üß†</span>
            Intel
        </button>
    </nav>
    
    <script>
        // Mobile panel functions
        function openMobilePanel(panelId) {
            document.getElementById('mobile-overlay').classList.add('show');
            document.getElementById(panelId).classList.add('show');
        }
        
        function closeMobilePanel() {
            document.getElementById('mobile-overlay').classList.remove('show');
            document.querySelectorAll('.mobile-panel').forEach(p => p.classList.remove('show'));
        }
    </script>
    
    <script>
        // State
        let isRunning = false;
        let autoEnabled = false;
        let autoInterval = null;
        let pollInterval = null;
        let allPositions = [];  // For position filtering/sorting
        
        // Helper: Format currency
        function formatCurrency(val) {
            if (val == null) return '$--';
            return '$' + parseFloat(val).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // Render positions table - defined early to ensure availability
        function updatePositionsTable(positions) {
            const tbody = document.getElementById('positions-body');
            if (!tbody) {
                console.error('positions-body element not found');
                return;
            }
            
            if (positions && positions.length > 0) {
                tbody.innerHTML = positions.map(p => {
                    const pl = p.unrealized_pl || 0;
                    const plpc = p.unrealized_plpc || 0;
                    const plClass = pl >= 0 ? 'positive' : 'negative';
                    const qty = parseFloat(p.qty) || 0;
                    
                    // Detect SHORT positions (negative quantity)
                    const isShort = qty < 0;
                    const qtyDisplay = isShort 
                        ? `<span style="color: var(--negative);">üìâ ${Math.abs(qty)} SHORT</span>`
                        : `<span style="color: var(--positive);">${qty}</span>`;
                    
                    // For shorts: profit when price goes DOWN
                    const shortLabel = isShort ? '<span style="font-size: 0.7em; color: var(--warning);">SHORT</span>' : '';
                    
                    return `
                        <tr style="${isShort ? 'background: rgba(239, 68, 68, 0.1);' : ''}">
                            <td class="ticker">${p.symbol || '--'} ${shortLabel}</td>
                            <td>${qtyDisplay}</td>
                            <td>${formatCurrency(p.avg_entry_price)}</td>
                            <td>${formatCurrency(p.current_price)}</td>
                            <td>${formatCurrency(Math.abs(p.market_value))}</td>
                            <td class="${plClass}">${formatCurrency(pl)}</td>
                            <td class="${plClass}">${(plpc * 100).toFixed(2)}%</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-dim); padding: 30px;">No positions</td></tr>';
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing Quant Fund UI...');
            
            try {
                await loadPortfolio();
                console.log('‚úì Portfolio loaded');
            } catch (e) {
                console.error('‚ùå Portfolio failed:', e);
            }
            
            loadLLMStats();
            loadLearning();
            loadAccuracy();
            loadExecutionQuality();
            loadTickerSentiment();
            loadNews();
            loadRiskAppetite();
            loadRegime();
            loadUniverseStats();
            loadMarketData();
            loadDataSources();
            
            // Refresh macro data on page load to get latest values
            try {
                await fetch('/api/macro/refresh', { method: 'POST' });
            } catch (e) {}
            loadMacro();
            calculateSuggestedExposure();
            
            // Poll for updates every 5s
            pollInterval = setInterval(() => {
                if (!isRunning) {
                    loadPortfolio();
                    loadMacro();  // Keep macro updated
                    loadRegime(); // Keep regime updated
                    loadMarketData(); // Keep market data updated
                }
                checkStatus();
            }, 5000);
        });
        
        // Run Rebalance
        async function runRebalance(skipConfirmation = false) {
            const btn = document.getElementById('run-btn');
            const dryRun = document.getElementById('dry-run').checked;
            const force = document.getElementById('force-rebalance').checked;
            const cancel = document.getElementById('cancel-previous').checked;
            const exposure = getExposurePercent();
            const riskAppetite = document.getElementById('risk-appetite').value;
            const fastMode = document.getElementById('fast-mode')?.checked ?? true;
            
            // Confirm if NOT dry run (live trading) - unless skipConfirmation is true (auto mode)
            if (!dryRun && !skipConfirmation) {
                if (!confirm('‚ö†Ô∏è LIVE TRADING MODE!\n\nThis will place REAL orders with REAL money.\n\nAre you sure you want to continue?')) {
                    return;
                }
            }
            
            btn.disabled = true;
            isRunning = true;
            const modeStr = fastMode ? '‚ö°FAST ' : '';
            updateStatus('running', dryRun ? `${modeStr}Simulating...` : `üî¥ ${modeStr}LIVE Trading...`);
            document.getElementById('execution-log').textContent = `Starting ${modeStr}rebalance (${exposure}% exposure, ${riskAppetite} risk, ${dryRun ? 'DRY RUN' : 'üî¥ LIVE'})...\n`;
            
            try {
                const response = await fetch(`/api/run?force=${force}&cancel_previous=${cancel}&exposure=${exposure}&dry_run=${dryRun}&risk_appetite=${riskAppetite}&fast_mode=${fastMode}`, {
                    method: 'POST'
                });
                
                // Poll for log updates
                const logPoll = setInterval(async () => {
                    try {
                        const statusRes = await fetch('/api/status');
                        const status = await statusRes.json();
                        
                        if (status.output) {
                            document.getElementById('execution-log').textContent = status.output;
                            document.getElementById('execution-log').scrollTop = document.getElementById('execution-log').scrollHeight;
                        }
                        
                        if (status.trade_reasoning) {
                            document.getElementById('llm-reasoning-text').textContent = status.trade_reasoning;
                        }
                        
                        if (status.debate_scores) {
                            updateDebateScores(status.debate_scores);
                        }
                        
                        if (!status.running) {
                            clearInterval(logPoll);
                            isRunning = false;
                            btn.disabled = false;
                            
                            if (status.error) {
                                updateStatus('error', 'Error');
                            } else {
                                updateStatus('success', 'Completed');
                            }
                            
                            loadPortfolio();
                            loadLearning();
                            loadMacro();
                            loadAccuracy();
                            loadExecutionQuality();
                        }
                    } catch (e) {
                        console.error('Poll error:', e);
                    }
                }, 1000);
                
            } catch (e) {
                console.error('Run error:', e);
                updateStatus('error', 'Failed');
                btn.disabled = false;
                isRunning = false;
            }
        }
        
        // Update status badge
        function updateStatus(type, text) {
            const badge = document.getElementById('status-badge');
            badge.className = `status-badge ${type}`;
            badge.querySelector('span').textContent = text;
        }
        
        // Load Portfolio
        async function loadPortfolio() {
            try {
                console.log('üìä Fetching portfolio...');
                const res = await fetch('/api/portfolio');
                
                if (!res.ok) {
                    console.error('‚ùå Portfolio API error:', res.status, res.statusText);
                    return;
                }
                
                const data = await res.json();
                
                if (data.error) {
                    console.error('‚ùå Portfolio API returned error:', data.error);
                    document.getElementById('positions-body').innerHTML = 
                        `<tr><td colspan="7" style="text-align: center; color: var(--danger); padding: 30px;">
                            Error: ${data.error}
                        </td></tr>`;
                    return;
                }
                
                console.log('üìä Portfolio loaded:', {
                    equity: data.equity,
                    cash: data.cash,
                    total_pl: data.total_pl,
                    positions: data.positions?.length
                });
                
                // Header stats
                document.getElementById('header-equity').textContent = formatCurrency(data.equity || 0);
                document.getElementById('header-pnl').textContent = formatCurrency(data.total_pl || 0);
                document.getElementById('header-pnl').className = (data.total_pl || 0) >= 0 ? 'positive' : 'negative';
                
                // Portfolio grid
                document.getElementById('total-equity').textContent = formatCurrency(data.equity);
                document.getElementById('total-cash').textContent = formatCurrency(data.cash);
                document.getElementById('invested').textContent = formatCurrency(data.market_value);
                document.getElementById('pnl-today').textContent = formatCurrency(data.total_pl);
                document.getElementById('pnl-today').className = data.total_pl >= 0 ? 'positive' : 'negative';
                document.getElementById('pnl-pct').textContent = (data.total_pl_pct || 0).toFixed(2) + '%';
                document.getElementById('pnl-pct').className = data.total_pl_pct >= 0 ? 'positive' : 'negative';
                document.getElementById('position-count').textContent = data.positions?.length || 0;
                
                // Last updated
                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
                
                // Positions table - store for filtering/sorting
                allPositions = data.positions || [];
                console.log('üìà Rendering', allPositions.length, 'positions');
                
                // Use unified render function
                updatePositionsTable(allPositions);
                console.log('‚úì Positions table updated');
            } catch (e) {
                console.error('Portfolio error:', e);
            }
        }
        
        // Load LLM Stats
        async function loadLLMStats() {
            try {
                const res = await fetch('/api/llm/stats');
                const data = await res.json();
                
                document.getElementById('header-llm').textContent = data.available ? '‚óè Online' : '‚óã Offline';
                document.getElementById('header-llm').style.color = data.available ? 'var(--success)' : 'var(--danger)';
                
                document.getElementById('llm-provider').textContent = data.provider || '--';
                document.getElementById('llm-model').textContent = data.model || '--';
                document.getElementById('llm-calls').textContent = data.daily_calls || 0;
                document.getElementById('llm-cache').textContent = ((data.cache_hit_rate || 0) * 100).toFixed(0) + '%';
            } catch (e) {
                console.error('LLM stats error:', e);
            }
        }
        
        // Load Learning - Comprehensive version
        async function loadLearning() {
            try {
                // Fetch real-time learning stats
                const res = await fetch('/api/learning/realtime');
                const data = await res.json();
                
                if (data.error) {
                    console.error('Learning API error:', data.error);
                    return;
                }
                
                // Update core metrics
                document.getElementById('learning-trades').textContent = data.total_trades || 0;
                
                const winRate = ((data.win_rate || 0) * 100);
                const winRateEl = document.getElementById('learning-winrate');
                winRateEl.textContent = winRate.toFixed(0) + '%';
                winRateEl.className = winRate >= 52 ? 'positive' : winRate < 48 ? 'negative' : '';
                
                document.getElementById('learning-patterns').textContent = data.patterns_active || 0;
                
                // Show P/L
                const pnl = data.total_pnl || 0;
                const pnlEl = document.getElementById('learning-pnl');
                pnlEl.textContent = pnl >= 0 ? `$${pnl.toFixed(0)}` : `-$${Math.abs(pnl).toFixed(0)}`;
                pnlEl.className = pnl >= 0 ? 'positive' : 'negative';
                
                // Update learning maturity badge
                const maturityEl = document.getElementById('learning-maturity');
                if (data.learning_maturity) {
                    maturityEl.textContent = data.learning_maturity.description || data.learning_maturity.level;
                    maturityEl.style.background = data.learning_maturity.level === 'mature' ? 'rgba(63, 185, 80, 0.2)' :
                                                  data.learning_maturity.level === 'maturing' ? 'rgba(88, 166, 255, 0.2)' :
                                                  'rgba(139, 148, 158, 0.2)';
                }
                
                // Update learning influence bar
                const influence = ((data.learning_influence || 0.3) * 100);
                document.getElementById('learning-influence-pct').textContent = influence.toFixed(0) + '% from learning';
                document.getElementById('learning-influence-bar').style.width = influence + '%';
                
                // Update top strategies
                const topStrategiesEl = document.getElementById('learning-top-strategies');
                if (data.top_strategies && data.top_strategies.length > 0) {
                    topStrategiesEl.innerHTML = data.top_strategies.map(s => 
                        `<div style="margin-bottom: 3px;">‚Ä¢ ${s.name.replace(/_/g, ' ')} <span style="color: #3fb950;">(${(s.weight * 100).toFixed(1)}%)</span></div>`
                    ).join('');
                } else {
                    topStrategiesEl.innerHTML = '<div>Gathering data...</div>';
                }
                
                // Update bottom strategies
                const bottomStrategiesEl = document.getElementById('learning-bottom-strategies');
                if (data.bottom_strategies && data.bottom_strategies.length > 0) {
                    bottomStrategiesEl.innerHTML = data.bottom_strategies.map(s => 
                        `<div style="margin-bottom: 3px;">‚Ä¢ ${s.name.replace(/_/g, ' ')} <span style="color: #f85149;">(${(s.weight * 100).toFixed(1)}%)</span></div>`
                    ).join('');
                } else {
                    bottomStrategiesEl.innerHTML = '<div>Gathering data...</div>';
                }
                
                // Update active patterns
                const patternsEl = document.getElementById('learning-active-patterns');
                if (data.active_patterns && data.active_patterns.length > 0) {
                    patternsEl.innerHTML = data.active_patterns.map(p => 
                        `<div style="margin-bottom: 5px; padding: 5px; background: rgba(88, 166, 255, 0.1); border-radius: 4px;">
                            <div style="color: var(--text-primary);">üìå ${p.description}</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 3px;">
                                <span style="color: var(--accent);">${p.action.replace(/_/g, ' ')}</span>
                                <span style="color: ${p.confidence >= 0.6 ? '#3fb950' : 'var(--text-dim)'}">${(p.confidence * 100).toFixed(0)}% conf</span>
                            </div>
                        </div>`
                    ).join('');
                } else {
                    patternsEl.innerHTML = '<div style="color: var(--text-dim);">No patterns currently active. Run more rebalances to discover patterns.</div>';
                }
                
                // Fetch key insights for the insight card
                try {
                    const reportRes = await fetch('/api/learning/report');
                    const reportData = await reportRes.json();
                    
                    if (reportData.key_insights && reportData.key_insights.length > 0) {
                        const insight = reportData.key_insights[0];
                        const insightCard = document.getElementById('learning-key-insight');
                        insightCard.style.display = 'block';
                        document.getElementById('learning-insight-text').textContent = insight.description;
                        document.getElementById('learning-insight-action').textContent = '‚Üí ' + insight.action;
                    }
                } catch (e) {
                    console.log('Could not load key insights:', e);
                }
                
                // Console log for debugging
                console.log('üß† Learning Dashboard Updated:', {
                    trades: data.total_trades,
                    winRate: winRate.toFixed(1) + '%',
                    influence: influence.toFixed(0) + '%',
                    patterns: data.patterns_active,
                    maturity: data.learning_maturity?.level
                });
                
            } catch (e) {
                console.error('Learning error:', e);
            }
        }
        
        // View full learning report
        function viewLearningReport() {
            window.open('/api/learning/report/html', '_blank');
        }
        
        // Download learning report
        function downloadLearningReport() {
            window.location.href = '/api/learning/report/download';
        }
        
        async function updateLearningOutcomes() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Updating...';
                
                const res = await fetch('/api/learning/update-outcomes', { method: 'POST' });
                const data = await res.json();
                
                btn.textContent = `‚úì Updated ${data.updated || 0}`;
                setTimeout(() => {
                    btn.textContent = 'üìä Update Outcomes';
                    btn.disabled = false;
                }, 2000);
                
                // Reload learning data
                loadLearning();
                
            } catch (e) {
                console.error('Update outcomes error:', e);
                event.target.textContent = '‚ùå Error';
                event.target.disabled = false;
            }
        }
        
        // Load Macro
        async function loadMacro() {
            try {
                const res = await fetch('/api/macro/features');
                const data = await res.json();
                
                console.log('Macro data:', data);  // Debug
                
                // Use 'indices' from API response - these are now HYBRID (real data + news)
                if (data.indices) {
                    updateMacroValue('macro-inflation', data.indices.macro_inflation_pressure_index);
                    updateMacroValue('macro-labor', data.indices.labor_strength_index);
                    updateMacroValue('macro-growth', data.indices.growth_momentum_index);
                    updateMacroValue('macro-cb', data.indices.central_bank_hawkishness_index);
                    updateMacroValue('macro-geo', data.indices.geopolitical_risk_index);
                    updateMacroValue('macro-stress', data.indices.financial_stress_index);
                    updateMacroValue('macro-commodity', data.indices.commodities_supply_risk_index);
                    
                    // Also update the overall risk sentiment with combined index
                    if (data.indices.overall_risk_sentiment_index !== undefined) {
                        const overallRisk = data.indices.overall_risk_sentiment_index;
                        // Convert -1 to 1 range to 0-100 gauge position
                        const gaugePos = (overallRisk + 1) * 50; // Maps -1 to 0%, 0 to 50%, 1 to 100%
                        document.getElementById('gauge-marker').style.left = `${Math.max(0, Math.min(100, gaugePos))}%`;
                        
                        let sentimentText = 'Neutral';
                        let sentimentColor = 'var(--text-secondary)';
                        if (overallRisk > 0.2) {
                            sentimentText = 'Risk-On';
                            sentimentColor = 'var(--success)';
                        } else if (overallRisk < -0.2) {
                            sentimentText = 'Risk-Off';
                            sentimentColor = 'var(--danger)';
                        }
                        const sentEl = document.getElementById('risk-sentiment-value');
                        sentEl.textContent = `${sentimentText} (${overallRisk.toFixed(2)})`;
                        sentEl.style.color = sentimentColor;
                    }
                }
                
                // Use real data risk score for sentiment
                if (data.sentiment) {
                    const sentiment = data.sentiment.overall_risk || 0.5;
                    // Convert 0-1 to gauge position (0% to 100%)
                    const gaugePos = sentiment * 100;
                    document.getElementById('gauge-marker').style.left = `${Math.max(0, Math.min(100, gaugePos))}%`;
                    
                    let sentimentText = 'Neutral';
                    let sentimentColor = 'var(--text-secondary)';
                    if (sentiment > 0.6) {
                        sentimentText = 'Risk-On';
                        sentimentColor = 'var(--success)';
                    } else if (sentiment < 0.4) {
                        sentimentText = 'Risk-Off';
                        sentimentColor = 'var(--danger)';
                    }
                    const sentEl = document.getElementById('risk-sentiment-value');
                    sentEl.textContent = `${sentimentText} (${(sentiment * 100).toFixed(0)}%)`;
                    sentEl.style.color = sentimentColor;
                }
                
                // Update with real market data if available
                if (data.real_data) {
                    const rd = data.real_data;
                    // Update live market panel with this data too
                    if (rd.vix) document.getElementById('live-vix').textContent = rd.vix.toFixed(1);
                    if (rd.spy_price) {
                        const spyEl = document.getElementById('live-spy');
                        spyEl.textContent = `$${rd.spy_price.toFixed(2)} (${rd.spy_change_pct >= 0 ? '+' : ''}${rd.spy_change_pct.toFixed(1)}%)`;
                        spyEl.style.color = rd.spy_change_pct >= 0 ? 'var(--success)' : 'var(--danger)';
                    }
                    if (rd.treasury_10y) document.getElementById('live-treasury').textContent = `${rd.treasury_10y.toFixed(2)}%`;
                    if (rd.gold) document.getElementById('live-gold').textContent = `$${rd.gold.toFixed(0)}`;
                    if (rd.oil) document.getElementById('live-oil').textContent = `$${rd.oil.toFixed(1)}`;
                    
                    // Update economic data display
                    if (rd.cpi_yoy) {
                        const cpiEl = document.getElementById('live-cpi');
                        cpiEl.textContent = `${rd.cpi_yoy.toFixed(1)}%`;
                        cpiEl.style.color = rd.cpi_yoy > 3 ? 'var(--danger)' : rd.cpi_yoy < 2 ? 'var(--success)' : 'var(--text-secondary)';
                    }
                    if (rd.unemployment) {
                        const unempEl = document.getElementById('live-unemployment');
                        unempEl.textContent = `${rd.unemployment.toFixed(1)}%`;
                        unempEl.style.color = rd.unemployment < 4 ? 'var(--success)' : rd.unemployment > 5 ? 'var(--danger)' : 'var(--text-secondary)';
                    }
                    if (rd.fed_funds) {
                        document.getElementById('live-fedfunds').textContent = `${rd.fed_funds.toFixed(2)}%`;
                    }
                    if (rd.financial_stress_fred !== undefined) {
                        const stressEl = document.getElementById('live-finstress');
                        const stress = rd.financial_stress_fred;
                        stressEl.textContent = stress.toFixed(2);
                        stressEl.style.color = stress > 0.5 ? 'var(--danger)' : stress < -0.5 ? 'var(--success)' : 'var(--text-secondary)';
                    }
                    
                    // Log the underlying data for transparency
                    console.log('üìä Real Economic Data Used:', {
                        'CPI YoY': rd.cpi_yoy?.toFixed(1) + '%',
                        'Unemployment': rd.unemployment?.toFixed(1) + '%',
                        'Fed Funds': rd.fed_funds?.toFixed(2) + '%',
                        'FRED Stress': rd.financial_stress_fred?.toFixed(2),
                        'VIX': rd.vix?.toFixed(1),
                        'SPY vs 200MA': rd.spy_vs_200ma?.toFixed(1) + '%',
                    });
                }
                
                // Log metadata for debugging
                if (data.metadata) {
                    console.log('üì∞ News Processing:', {
                        'Events': data.metadata.event_count,
                        'High Impact': data.metadata.high_impact_events,
                        'Quality': (data.metadata.data_quality * 100).toFixed(0) + '%',
                        'Last Update': data.metadata.last_news_update,
                    });
                }
            } catch (e) {
                console.error('Macro error:', e);
            }
        }
        
        function updateMacroValue(id, value) {
            const el = document.getElementById(id);
            el.textContent = (value || 0).toFixed(2);
            el.className = value > 0.1 ? 'positive' : value < -0.1 ? 'negative' : '';
        }
        
        // Load Signal Accuracy
        async function loadAccuracy() {
            try {
                const res = await fetch('/api/signals/accuracy');
                const data = await res.json();
                
                // Handle case where accuracy isn't available yet
                const acc1d = data.accuracy_1d;
                const acc5d = data.accuracy_5d;
                
                document.getElementById('accuracy-1d').textContent = 
                    acc1d !== null && acc1d !== undefined ? ((acc1d || 0) * 100).toFixed(0) + '%' : '--';
                document.getElementById('accuracy-5d').textContent = 
                    acc5d !== null && acc5d !== undefined ? ((acc5d || 0) * 100).toFixed(0) + '%' : '--';
                document.getElementById('sentiment-edge').textContent = 
                    `${data.total_signals || 0} signals`;
            } catch (e) {
                console.error('Accuracy error:', e);
            }
        }
        
        // Report Generation Functions
        async function generateReport(type) {
            try {
                const statusEl = document.getElementById('report-status');
                statusEl.textContent = `üîÑ Generating ${type} report with live data...`;
                statusEl.style.color = 'var(--accent)';
                
                const res = await fetch('/api/reports/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: type})
                });
                
                const data = await res.json();
                
                if (data.success) {
                    statusEl.textContent = `‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} report generated with charts!`;
                    statusEl.style.color = 'var(--success)';
                    
                    // Open the HTML report in a new tab
                    setTimeout(() => {
                        if (data.view_url) {
                            window.open(data.view_url, '_blank');
                        } else if (data.html_path) {
                            const filename = data.html_path.split('/').pop();
                            window.open(`/api/reports/view/${filename}`, '_blank');
                        }
                    }, 500);
                } else {
                    statusEl.textContent = `‚ùå Error: ${data.error}`;
                    statusEl.style.color = 'var(--danger)';
                }
            } catch (e) {
                console.error('Report generation error:', e);
                document.getElementById('report-status').textContent = `‚ùå Error: ${e.message}`;
                document.getElementById('report-status').style.color = 'var(--danger)';
            }
        }
        
        async function listReports() {
            try {
                const res = await fetch('/api/reports/list');
                const data = await res.json();
                
                if (data.reports && data.reports.length > 0) {
                    const reportList = data.reports.map(r => {
                        const viewUrl = r.filename.endsWith('.html') 
                            ? `/api/reports/view/${r.filename}` 
                            : `/api/reports/download/${r.filename}`;
                        return `<div style="margin-bottom: 5px;">
                            <a href="${viewUrl}" target="_blank" style="color: var(--accent);">
                                üìä ${r.filename}
                            </a>
                            <span style="color: var(--text-dim); font-size: 0.8em;"> (${new Date(r.modified).toLocaleDateString()})</span>
                        </div>`;
                    }).join('');
                    
                    document.getElementById('report-status').innerHTML = `
                        <div style="border-top: 1px solid var(--border); padding-top: 8px; margin-top: 8px;">
                            <strong>Available Reports:</strong>
                            ${reportList}
                        </div>
                    `;
                } else {
                    document.getElementById('report-status').textContent = 'No reports generated yet';
                }
            } catch (e) {
                console.error('List reports error:', e);
            }
        }
        
        // Load Execution Quality (Phase 2 Enhanced)
        async function loadExecutionQuality() {
            try {
                // Get basic stats
                const res = await fetch('/api/execution/stats');
                const data = await res.json();
                
                document.getElementById('exec-total').textContent = data.total_orders || 0;
                
                const fillRate = data.fill_rate || 0;
                document.getElementById('exec-fill-rate').textContent = fillRate.toFixed(0) + '%';
                document.getElementById('exec-fill-rate').className = fillRate >= 30 ? 'positive' : '';
                
                const improvement = data.total_improvement || 0;
                document.getElementById('exec-improvement').textContent = '$' + improvement.toFixed(2);
                document.getElementById('exec-improvement').className = improvement >= 0 ? 'positive' : 'negative';
                
                const spread = data.avg_spread_pct || 0;
                document.getElementById('exec-spread').textContent = spread.toFixed(3) + '%';
                
                // Get insights
                const insightsRes = await fetch('/api/execution/insights');
                const insights = await insightsRes.json();
                
                document.getElementById('exec-symbols').textContent = insights.symbols_with_history || 0;
                
                const insightsContainer = document.getElementById('exec-insights');
                if (insights.best_fill_rate && insights.best_fill_rate.length > 0) {
                    const best = insights.best_fill_rate[0];
                    insightsContainer.innerHTML = `
                        <div style="margin-bottom: 4px;">
                            <span style="color: var(--success);">üèÜ Best:</span> ${best.symbol} (${(best.fill_rate * 100).toFixed(0)}% fill)
                        </div>
                        ${insights.worst_fill_rate && insights.worst_fill_rate.length > 0 ? `
                        <div>
                            <span style="color: var(--warning);">‚ö†Ô∏è Slowest:</span> ${insights.worst_fill_rate[0].symbol} (${(insights.worst_fill_rate[0].fill_rate * 100).toFixed(0)}% fill)
                        </div>
                        ` : ''}
                    `;
                } else {
                    insightsContainer.innerHTML = '<div>Run more trades to see insights</div>';
                }
            } catch (e) {
                console.error('Execution quality error:', e);
            }
        }
        
        // Load Ticker Sentiment
        async function loadTickerSentiment() {
            try {
                // First refresh sentiment from cached articles if needed
                let res = await fetch('/api/ticker-sentiment');
                let data = await res.json();
                
                // If no sentiment, try refreshing from cache
                if (!data.sentiments || Object.keys(data.sentiments).length === 0) {
                    await fetch('/api/ticker-sentiment/refresh', { method: 'POST' });
                    res = await fetch('/api/ticker-sentiment');
                    data = await res.json();
                }
                
                const container = document.getElementById('ticker-sentiments');
                if (data.sentiments && Object.keys(data.sentiments).length > 0) {
                    // Sort by absolute sentiment score to show strongest signals
                    const sorted = Object.entries(data.sentiments)
                        .sort((a, b) => Math.abs(b[1].sentiment_score) - Math.abs(a[1].sentiment_score))
                        .slice(0, 6);
                    
                    container.innerHTML = `
                        <div style="font-size: 0.7em; color: var(--text-dim); margin-bottom: 8px;">
                            ${Object.keys(data.sentiments).length} tickers analyzed
                        </div>
                        ${sorted.map(([ticker, s]) => `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span class="ticker">${ticker}</span>
                                <span class="${s.sentiment_score > 0 ? 'positive' : 'negative'}" style="font-family: 'JetBrains Mono', monospace;">
                                    ${s.sentiment_score > 0 ? '‚Üë' : '‚Üì'}${Math.abs(s.sentiment_score).toFixed(2)}
                                </span>
                            </div>
                        `).join('')}
                    `;
                } else {
                    container.innerHTML = '<div style="color: var(--text-dim);">Loading sentiment...</div>';
                }
            } catch (e) {
                console.error('Ticker sentiment error:', e);
            }
        }
        
        // Update Debate Scores
        function updateDebateScores(scores) {
            const container = document.getElementById('debate-scores');
            if (!scores) return;
            
            const sorted = Object.entries(scores)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            container.innerHTML = sorted.map(([name, score]) => {
                const pct = Math.min(100, Math.max(0, score * 100));
                return `
                    <div class="debate-score">
                        <span style="color: var(--text-dim); width: 80px; font-size: 0.75em;">${name.replace('Strategy', '')}</span>
                        <div class="bar"><div class="bar-fill" style="width: ${pct}%;"></div></div>
                        <span style="font-family: 'JetBrains Mono'; font-size: 0.8em;">${score.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
        }
        
        // Check Status
        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                if (data.running && !isRunning) {
                    isRunning = true;
                    updateStatus('running', 'Running...');
                } else if (!data.running && isRunning) {
                    isRunning = false;
                    updateStatus('idle', 'Ready');
                }
            } catch (e) {}
        }
        
        // Refresh Macro
        async function refreshMacro() {
            // Show loading state
            document.getElementById('macro-inflation').textContent = '...';
            document.getElementById('macro-labor').textContent = '...';
            document.getElementById('macro-growth').textContent = '...';
            document.getElementById('macro-cb').textContent = '...';
            document.getElementById('macro-geo').textContent = '...';
            document.getElementById('macro-stress').textContent = '...';
            document.getElementById('macro-commodity').textContent = '...';
            
            try {
                const res = await fetch('/api/macro/refresh', { method: 'POST' });
                const result = await res.json();
                console.log('Macro refresh result:', result);
                
                await loadMacro();
                calculateSuggestedExposure();  // Update suggested exposure too
            } catch (e) {
                console.error('Refresh macro error:', e);
            }
        }
        
        // Refresh Data
        async function refreshData() {
            // Show loading state
            updateStatus('running', 'Refreshing all data...');
            document.getElementById('news-list').innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 20px;"><div class="loading"></div> Fetching...</div>';
            
            try {
                // Trigger server-side refresh of ALL data sources
                await fetch('/api/background-refresh/trigger', { method: 'POST' });
                
                // Reload all UI components (force refresh news)
                await Promise.all([
                    loadPortfolio(),
                    loadLLMStats(),
                    loadLearning(),
                    loadMacro(),
                    loadAccuracy(),
                    loadTickerSentiment(),
                    loadNews(true),  // Force refresh news
                    loadMarketData(),
                    loadRegime(),
                ]);
                
                updateStatus('success', 'All data refreshed!');
                setTimeout(() => updateStatus('idle', 'Ready'), 2000);
            } catch (e) {
                console.error('Refresh error:', e);
                updateStatus('error', 'Refresh failed');
            }
        }
        
        // Cancel Orders
        async function cancelOrders() {
            try {
                await fetch('/api/cancel-orders', { method: 'POST' });
                alert('All orders cancelled');
            } catch (e) {
                alert('Failed to cancel orders');
            }
        }
        
        // Toggle Auto - runs automatically WITHOUT confirmation dialogs
        function toggleAuto() {
            autoEnabled = !autoEnabled;
            const btn = document.getElementById('auto-btn');
            
            if (autoEnabled) {
                const interval = parseInt(document.getElementById('auto-interval').value) || 60;
                btn.textContent = `Disable (${interval}m)`;
                btn.classList.add('danger');
                btn.classList.remove('secondary');
                
                // Run immediately on enable
                if (!isRunning) {
                    console.log('‚ö° Auto-rebalance: Running immediately (no confirmation)');
                    runRebalance(true);  // skipConfirmation = true
                }
                
                // Then schedule regular runs
                autoInterval = setInterval(() => {
                    if (!isRunning) {
                        console.log(`‚ö° Auto-rebalance: Scheduled run (every ${interval}m)`);
                        runRebalance(true);  // skipConfirmation = true for auto mode
                    }
                }, interval * 60 * 1000);
                
                updateStatus('success', `Auto-rebalance enabled (every ${interval} min)`);
            } else {
                btn.textContent = 'Enable';
                btn.classList.remove('danger');
                btn.classList.add('secondary');
                
                if (autoInterval) clearInterval(autoInterval);
                updateStatus('idle', 'Auto-rebalance disabled');
            }
        }
        
        // Clear Log
        function clearLog() {
            document.getElementById('execution-log').textContent = '';
        }
        
        // Load News Headlines
        async function loadNews(forceRefresh = false) {
            try {
                const container = document.getElementById('news-list');
                
                // Fetch news - use refresh=true to get fresh data from API
                const url = forceRefresh 
                    ? '/api/alpha-vantage/fetch?limit=30&refresh=true' 
                    : '/api/alpha-vantage/fetch?limit=30';
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();
                
                // Check for rate limit status
                const rateLimit = data.rate_limit || {};
                let rateLimitBanner = '';
                if (rateLimit.rate_limited) {
                    rateLimitBanner = `
                        <div style="background: rgba(255,152,0,0.15); border: 1px solid rgba(255,152,0,0.3); border-radius: 6px; padding: 8px; margin-bottom: 10px;">
                            <div style="color: #ff9800; font-size: 0.8em; font-weight: 600;">‚ö†Ô∏è API Daily Limit Reached</div>
                            <div style="color: var(--text-dim); font-size: 0.7em; margin-top: 4px;">
                                Showing cached news from ${rateLimit.hours_since_fresh_news || '?'}h ago.<br>
                                Limit resets at midnight UTC.
                            </div>
                        </div>
                    `;
                }
                
                if (data.articles && data.articles.length > 0) {
                    // Sort by timestamp (newest first)
                    const sorted = data.articles.sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );
                    
                    container.innerHTML = rateLimitBanner + sorted.slice(0, 25).map(article => {
                        const score = article.overall_sentiment_score || 0;
                        const scoreColor = score > 0.1 ? 'var(--success)' : score < -0.1 ? 'var(--danger)' : 'var(--text-dim)';
                        const scoreBg = score > 0.1 ? 'rgba(0,245,147,0.15)' : score < -0.1 ? 'rgba(255,71,87,0.15)' : 'var(--bg-secondary)';
                        
                        // Calculate relative time
                        const newsDate = new Date(article.timestamp);
                        const hoursAgo = Math.round((Date.now() - newsDate) / (1000 * 60 * 60));
                        const timeStr = hoursAgo < 1 ? 'Just now' : hoursAgo < 24 ? `${hoursAgo}h ago` : `${Math.round(hoursAgo/24)}d ago`;
                        
                        return `
                            <div style="padding: 10px 0; border-bottom: 1px solid var(--border);">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.85em; margin-bottom: 4px;">${article.headline || article.title}</div>
                                        <div style="font-size: 0.7em; color: var(--text-dim);">
                                            ${article.source} ‚Ä¢ ${timeStr}
                                        </div>
                                    </div>
                                    <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.7em; background: ${scoreBg}; color: ${scoreColor}; white-space: nowrap;">
                                        ${score > 0 ? '+' : ''}${(score * 100).toFixed(0)}%
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Show count and cache status
                    const countDiv = document.createElement('div');
                    countDiv.style.cssText = 'text-align: center; font-size: 0.7em; color: var(--text-dim); padding: 8px;';
                    const cacheNote = rateLimit.rate_limited ? ' (cached)' : '';
                    countDiv.textContent = `Showing ${Math.min(25, sorted.length)} of ${data.articles_fetched} articles${cacheNote}`;
                    container.appendChild(countDiv);
                } else {
                    container.innerHTML = rateLimitBanner + '<div style="text-align: center; color: var(--text-dim); padding: 20px;">No news available. Click Refresh to fetch.</div>';
                }
            } catch (e) {
                console.error('News error:', e);
                document.getElementById('news-list').innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 20px;">Failed to load news</div>';
            }
        }
        
        // Refresh News - Force fetch from API
        async function refreshNews() {
            document.getElementById('news-list').innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 20px;"><div class="loading"></div> Fetching latest news from Alpha Vantage...</div>';
            await loadNews(true);  // Force refresh
        }
        
        // News filtering
        let allNews = [];
        let currentNewsFilter = 'all';
        
        function filterNews(query) {
            query = query.toLowerCase().trim();
            if (!allNews.length) return;
            
            let filtered = allNews;
            
            if (currentNewsFilter !== 'all') {
                filtered = filtered.filter(a => 
                    (a.tickers || []).some(t => t.toUpperCase() === currentNewsFilter)
                );
            }
            
            if (query) {
                filtered = filtered.filter(a => 
                    (a.headline || a.title || '').toLowerCase().includes(query) ||
                    (a.source || '').toLowerCase().includes(query)
                );
            }
            
            renderNewsItems(filtered);
        }
        
        function setNewsFilter(ticker) {
            currentNewsFilter = ticker;
            
            document.querySelectorAll('.news-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === ticker || (ticker === 'all' && btn.textContent === 'All'));
            });
            
            filterNews(document.getElementById('news-search').value);
        }
        
        function renderNewsItems(articles) {
            const container = document.getElementById('news-list');
            
            if (!articles.length) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-dim); padding: 20px;">No matching news</div>';
                return;
            }
            
            container.innerHTML = articles.slice(0, 25).map(article => {
                const score = article.overall_sentiment_score || 0;
                const scoreColor = score > 0.1 ? 'var(--success)' : score < -0.1 ? 'var(--danger)' : 'var(--text-dim)';
                const scoreBg = score > 0.1 ? 'rgba(0,245,147,0.15)' : score < -0.1 ? 'rgba(255,71,87,0.15)' : 'var(--bg-secondary)';
                
                const newsDate = new Date(article.timestamp);
                const hoursAgo = Math.round((Date.now() - newsDate) / (1000 * 60 * 60));
                const timeStr = hoursAgo < 1 ? 'Just now' : hoursAgo < 24 ? `${hoursAgo}h ago` : `${Math.round(hoursAgo/24)}d ago`;
                
                const tickers = (article.tickers || []).slice(0, 3).join(', ');
                
                return `
                    <div style="padding: 10px 0; border-bottom: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                            <div style="flex: 1;">
                                <div style="font-size: 0.85em; margin-bottom: 4px;">${article.headline || article.title}</div>
                                <div style="font-size: 0.7em; color: var(--text-dim);">
                                    ${article.source} ‚Ä¢ ${timeStr}${tickers ? ` ‚Ä¢ <span style="color: var(--accent);">${tickers}</span>` : ''}
                                </div>
                            </div>
                            <span style="padding: 2px 8px; border-radius: 4px; font-size: 0.7em; background: ${scoreBg}; color: ${scoreColor}; white-space: nowrap;">
                                ${score > 0 ? '+' : ''}${(score * 100).toFixed(0)}%
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Enhance loadNews to populate filters
        const originalLoadNews = loadNews;
        loadNews = async function(forceRefresh = false) {
            await originalLoadNews(forceRefresh);
            
            // Extract tickers from news and create filter buttons
            try {
                const res = await fetch('/api/alpha-vantage/fetch?limit=50', { method: 'POST' });
                const data = await res.json();
                
                if (data.articles) {
                    allNews = data.articles.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Get unique tickers
                    const tickerCounts = {};
                    allNews.forEach(a => {
                        (a.tickers || []).forEach(t => {
                            tickerCounts[t] = (tickerCounts[t] || 0) + 1;
                        });
                    });
                    
                    // Get top tickers
                    const topTickers = Object.entries(tickerCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 8)
                        .map(([t]) => t);
                    
                    // Update filter buttons
                    const filterRow = document.getElementById('news-ticker-filters');
                    filterRow.innerHTML = '<button class="news-filter-btn active" onclick="setNewsFilter(\'all\')">All</button>' +
                        topTickers.map(t => `<button class="news-filter-btn" onclick="setNewsFilter('${t}')">${t}</button>`).join('');
                }
            } catch (e) {
                console.log('Could not populate news filters');
            }
        };
        
        // Capital Exposure Functions
        function toggleExposureMode() {
            const isAuto = document.getElementById('exposure-auto').checked;
            const manualInput = document.getElementById('exposure-pct');
            const autoInfo = document.getElementById('auto-exposure-info');
            
            manualInput.disabled = isAuto;
            autoInfo.style.display = isAuto ? 'block' : 'none';
            
            if (isAuto) {
                calculateSuggestedExposure();
            }
        }
        
        async function calculateSuggestedExposure() {
            try {
                const res = await fetch('/api/suggested-exposure');
                const data = await res.json();
                
                const suggestedPct = data.suggested_exposure_pct || 80;
                document.getElementById('suggested-exposure').textContent = suggestedPct + '%';
                
                // Show reasons in tooltip
                if (data.reasons && data.reasons.length > 0) {
                    document.getElementById('auto-exposure-info').title = data.reasons.join('\n');
                }
            } catch (e) {
                document.getElementById('suggested-exposure').textContent = '80%';
            }
        }
        
        function getExposurePercent() {
            const isAuto = document.getElementById('exposure-auto').checked;
            if (isAuto) {
                const suggested = document.getElementById('suggested-exposure').textContent;
                return parseInt(suggested) || 80;
            }
            return parseInt(document.getElementById('exposure-pct').value) || 80;
        }
        
        // Update Risk Appetite
        async function updateRiskAppetite() {
            const appetite = document.getElementById('risk-appetite').value;
            try {
                const res = await fetch('/api/risk-appetite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ risk_appetite: appetite })
                });
                const data = await res.json();
                
                if (data.settings) {
                    document.getElementById('risk-appetite-info').textContent = 
                        `Min Position: ${(data.settings.min_position_pct * 100).toFixed(0)}% | Max: ${data.settings.max_positions} stocks`;
                }
            } catch (e) {
                console.error('Risk appetite error:', e);
            }
        }
        
        // Load Risk Appetite
        async function loadRiskAppetite() {
            try {
                const res = await fetch('/api/risk-appetite');
                const data = await res.json();
                
                document.getElementById('risk-appetite').value = data.risk_appetite;
                if (data.settings) {
                    document.getElementById('risk-appetite-info').textContent = 
                        `Min Position: ${(data.settings.min_position_pct * 100).toFixed(0)}% | Max: ${data.settings.max_positions} stocks`;
                }
            } catch (e) {
                console.error('Load risk appetite error:', e);
            }
        }
        
        // Load Regime
        async function loadRegime() {
            try {
                const res = await fetch('/api/regime');
                const data = await res.json();
                
                const label = document.getElementById('regime-label');
                const regimeText = (data.regime || 'unknown').replace('_', ' ').toUpperCase();
                label.textContent = regimeText;
                
                // Color based on regime
                if (data.regime === 'strong_bull') {
                    label.style.color = 'var(--success)';
                } else if (data.regime === 'mild_bull') {
                    label.style.color = '#7fff00';
                } else if (data.regime === 'neutral') {
                    label.style.color = 'var(--text-secondary)';
                } else if (data.regime === 'mild_bear') {
                    label.style.color = '#ffa500';
                } else if (data.regime === 'strong_bear') {
                    label.style.color = 'var(--danger)';
                }
                
                document.getElementById('regime-score').textContent = `Score: ${(data.score || 0).toFixed(2)}`;
                document.getElementById('regime-exposure').textContent = `Exposure: ${((data.exposure_multiplier || 1) * 100).toFixed(0)}%`;
            } catch (e) {
                console.error('Load regime error:', e);
            }
        }
        
        // Load Universe Stats
        async function loadUniverseStats() {
            try {
                const res = await fetch('/api/universe-stats');
                const data = await res.json();
                console.log('Universe stats:', data);
            } catch (e) {
                console.error('Universe stats error:', e);
            }
        }
        
        // Load Live Market Data
        async function loadMarketData() {
            try {
                const res = await fetch('/api/market-data');
                const data = await res.json();
                
                if (data.data) {
                    const d = data.data;
                    
                    // VIX
                    const vixEl = document.getElementById('live-vix');
                    vixEl.textContent = d.vix ? d.vix.toFixed(1) : '--';
                    if (d.vix > 25) vixEl.style.color = 'var(--danger)';
                    else if (d.vix > 20) vixEl.style.color = '#ffa500';
                    else vixEl.style.color = 'var(--success)';
                    
                    // SPY
                    const spyEl = document.getElementById('live-spy');
                    const spyChange = d.spy_change_pct || 0;
                    spyEl.textContent = `$${d.spy_price?.toFixed(2) || '--'} (${spyChange >= 0 ? '+' : ''}${spyChange.toFixed(1)}%)`;
                    spyEl.style.color = spyChange >= 0 ? 'var(--success)' : 'var(--danger)';
                    
                    // Treasury
                    document.getElementById('live-treasury').textContent = d.treasury_10y ? `${d.treasury_10y.toFixed(2)}%` : '--';
                    
                    // Risk Score
                    const riskEl = document.getElementById('live-risk');
                    const risk = d.risk_score || 0.5;
                    riskEl.textContent = risk.toFixed(2);
                    if (risk > 0.6) {
                        riskEl.style.color = 'var(--success)';
                        riskEl.textContent += ' (Risk-On)';
                    } else if (risk < 0.4) {
                        riskEl.style.color = 'var(--danger)';
                        riskEl.textContent += ' (Risk-Off)';
                    } else {
                        riskEl.style.color = 'var(--text-secondary)';
                        riskEl.textContent += ' (Neutral)';
                    }
                }
                
                // Update FRED status
                if (data.sources) {
                    const fredStatus = document.getElementById('fred-status');
                    if (data.sources.fred_api) {
                        fredStatus.textContent = '‚óè';
                        fredStatus.style.color = 'var(--success)';
                    }
                }
            } catch (e) {
                console.error('Market data error:', e);
            }
        }
        
        // Refresh Market Data
        async function refreshMarketData() {
            document.getElementById('live-vix').textContent = '...';
            document.getElementById('live-spy').textContent = '...';
            
            try {
                await fetch('/api/market-data/refresh', { method: 'POST' });
                await loadMarketData();
            } catch (e) {
                console.error('Refresh market data error:', e);
            }
        }
        
        // Load Data Sources Status
        async function loadDataSources() {
            try {
                const res = await fetch('/api/data-sources/status');
                const data = await res.json();
                
                // Update FRED status
                if (data.fred) {
                    const fredStatus = document.getElementById('fred-status');
                    if (data.fred.status === 'connected') {
                        fredStatus.textContent = '‚óè';
                        fredStatus.style.color = 'var(--success)';
                    }
                }
            } catch (e) {
                console.error('Data sources error:', e);
            }
        }
        
        // ========== TOAST NOTIFICATION SYSTEM ==========
        function showToast(type, title, message, duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úì',
                error: '‚úó',
                warning: '‚ö†',
                info: '‚Ñπ'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || '‚Ñπ'}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <span class="toast-close" onclick="this.parentElement.remove()">√ó</span>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
            
            return toast;
        }
        
        // ========== KEYBOARD SHORTCUTS ==========
        document.addEventListener('keydown', function(e) {
            // Don't trigger shortcuts when typing in inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }
            
            switch(e.key.toLowerCase()) {
                case 'r':
                    if (!isRunning) runRebalance();
                    break;
                case 'f':
                    refreshData();
                    showToast('info', 'Refreshing', 'Updating all data...');
                    break;
                case 'q':
                    const fastMode = document.getElementById('fast-mode');
                    fastMode.checked = !fastMode.checked;
                    showToast('info', 'Fast Mode', fastMode.checked ? 'Enabled (skip LLM)' : 'Disabled (full debate)');
                    break;
                case 'd':
                    const dryRun = document.getElementById('dry-run');
                    dryRun.checked = !dryRun.checked;
                    showToast('info', 'Dry Run', dryRun.checked ? 'Enabled (simulation)' : 'Disabled (real trades)');
                    break;
                case 'c':
                    cancelOrders();
                    break;
                case '?':
                    document.getElementById('shortcuts-modal').classList.toggle('show');
                    break;
                case '/':
                    e.preventDefault();
                    document.getElementById('position-search').focus();
                    break;
                case 'escape':
                    document.getElementById('shortcuts-modal').classList.remove('show');
                    break;
            }
        });
        
        // ========== POSITION SORTING ==========
        let currentSort = { field: null, direction: 'asc' };
        
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('sortable')) {
                const field = e.target.dataset.sort;
                
                // Toggle direction
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = 'asc';
                }
                
                // Update UI
                document.querySelectorAll('.sortable').forEach(th => {
                    th.classList.remove('asc', 'desc');
                });
                e.target.classList.add(currentSort.direction);
                
                // Sort positions
                sortPositions(field, currentSort.direction);
            }
        });
        
        function sortPositions(field, direction) {
            if (!allPositions || allPositions.length === 0) return;
            
            const sorted = [...allPositions].sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle strings
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal?.toLowerCase() || '';
                }
                
                // Handle numbers
                if (typeof aVal === 'number' || !isNaN(parseFloat(aVal))) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            updatePositionsTable(sorted);
        }
        
        // ========== POSITION TAB SYSTEM ==========
        function switchPositionTab(tab) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            
            // Update content
            document.getElementById('tab-current').classList.toggle('active', tab === 'current');
            document.getElementById('tab-history').classList.toggle('active', tab === 'history');
            
            // Load history if switching to that tab
            if (tab === 'history') {
                loadTradeHistory();
            }
        }
        
        // Store all positions for filtering
        function filterPositions(query) {
            query = query.toLowerCase().trim();
            const tbody = document.getElementById('positions-body');
            
            if (!query) {
                // Show all positions
                updatePositionsTable(allPositions);
                return;
            }
            
            const filtered = allPositions.filter(p => 
                p.symbol.toLowerCase().includes(query)
            );
            updatePositionsTable(filtered);
        }
        
        // ========== TRADE HISTORY ==========
        async function loadTradeHistory() {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-dim); padding: 20px;"><div class="skeleton skeleton-text" style="width: 150px; margin: 0 auto;"></div></td></tr>';
            
            try {
                const res = await fetch('/api/trade-history');
                const data = await res.json();
                
                if (data.trades && data.trades.length > 0) {
                    tbody.innerHTML = data.trades.slice(0, 50).map(t => `
                        <tr>
                            <td style="font-size: 0.8em;">${new Date(t.timestamp).toLocaleString()}</td>
                            <td class="ticker">${t.symbol}</td>
                            <td style="color: ${t.side === 'buy' ? 'var(--success)' : 'var(--danger)'};">${t.side.toUpperCase()}</td>
                            <td>${t.qty}</td>
                            <td>${formatCurrency(t.price)}</td>
                            <td>${formatCurrency(t.notional || t.qty * t.price)}</td>
                            <td class="${(t.pnl || 0) >= 0 ? 'positive' : 'negative'}">${t.pnl ? formatCurrency(t.pnl) : '--'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-dim); padding: 30px;">No trade history available</td></tr>';
                }
            } catch (e) {
                console.error('Trade history error:', e);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--text-dim); padding: 30px;">Could not load trade history</td></tr>';
            }
        }
        
        // ========== QUICK STATS ==========
        async function loadQuickStats() {
            try {
                const [portfolioRes, learningRes, leverageRes] = await Promise.all([
                    fetch('/api/portfolio'),
                    fetch('/api/learning/realtime'),
                    fetch('/api/leverage')
                ]);
                
                const portfolio = await portfolioRes.json();
                const learning = await learningRes.json();
                
                // Today's P/L
                const todayPL = portfolio.total_pl || 0;
                const todayPct = portfolio.total_pl_pct || 0;
                document.getElementById('qs-today').textContent = formatCurrency(todayPL);
                document.getElementById('qs-today').className = `quick-stat-value ${todayPL >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('qs-today-pct').textContent = `${todayPct >= 0 ? '+' : ''}${todayPct.toFixed(2)}%`;
                document.getElementById('qs-today-pct').className = `quick-stat-change ${todayPct >= 0 ? 'positive' : 'negative'}`;
                
                // Week P/L (estimated from learning data)
                const weekPL = learning.total_pnl || 0;
                document.getElementById('qs-week').textContent = formatCurrency(weekPL);
                document.getElementById('qs-week').className = `quick-stat-value ${weekPL >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('qs-week-pct').textContent = `${learning.total_trades || 0} trades`;
                
                // Win Rate
                const winRate = (learning.win_rate || 0) * 100;
                document.getElementById('qs-winrate').textContent = winRate.toFixed(0) + '%';
                document.getElementById('qs-winrate').className = `quick-stat-value ${winRate >= 52 ? 'positive' : winRate < 48 ? 'negative' : ''}`;
                document.getElementById('qs-trades').textContent = `${learning.total_trades || 0} trades`;
                
                // Leverage data
                if (leverageRes.ok) {
                    const leverage = await leverageRes.json();
                    updateLeverageDisplay(leverage);
                }
                
            } catch (e) {
                console.error('Quick stats error:', e);
            }
        }
        
        // ========== LEVERAGE DISPLAY ==========
        function updateLeverageDisplay(leverage) {
            // Quick stats
            const currentLev = leverage.current_leverage || 1.0;
            const maxLev = leverage.effective_max_leverage || 2.0;
            const state = leverage.state || 'healthy';
            const marginBuffer = leverage.margin_buffer_pct || 100;
            const buyingPower = leverage.buying_power || 0;
            
            document.getElementById('qs-leverage').textContent = `${currentLev.toFixed(2)}x`;
            document.getElementById('qs-leverage').className = `quick-stat-value ${currentLev > 1.5 ? 'negative' : currentLev > 1.0 ? 'warning' : ''}`;
            document.getElementById('qs-leverage-state').textContent = state;
            document.getElementById('qs-leverage-state').className = `quick-stat-change ${state === 'healthy' ? 'positive' : state === 'caution' ? 'warning' : 'negative'}`;
            
            document.getElementById('qs-margin').textContent = `${marginBuffer.toFixed(0)}%`;
            document.getElementById('qs-margin').className = `quick-stat-value ${marginBuffer > 50 ? 'positive' : marginBuffer > 25 ? 'warning' : 'negative'}`;
            document.getElementById('qs-buying-power').textContent = formatCurrency(buyingPower);
            
            // Add click handler for leverage card to open modal
            const leverageCard = document.getElementById('qs-leverage-card');
            if (leverageCard && !leverageCard.onclick) {
                leverageCard.onclick = () => {
                    loadLeverageStatus();
                    document.getElementById('leverage-modal').classList.add('show');
                };
                leverageCard.style.cursor = 'pointer';
            }
        }
        
        async function loadLeverageStatus() {
            try {
                const res = await fetch('/api/leverage');
                if (!res.ok) return;
                
                const leverage = await res.json();
                
                // Update modal
                document.getElementById('lev-current').textContent = `${(leverage.current_leverage || 0).toFixed(2)}x`;
                document.getElementById('lev-max').textContent = `${(leverage.effective_max_leverage || 2).toFixed(2)}x`;
                document.getElementById('lev-margin-used').textContent = `${(leverage.margin_used_pct || 0).toFixed(1)}%`;
                document.getElementById('lev-margin-buffer').textContent = `${(leverage.margin_buffer_pct || 100).toFixed(1)}%`;
                
                // Color based on state
                const state = leverage.state || 'healthy';
                const stateColors = {
                    'healthy': 'var(--green)',
                    'caution': '#f59e0b',
                    'warning': '#f97316',
                    'critical': 'var(--red)',
                    'emergency': 'var(--red)'
                };
                document.getElementById('lev-current').style.color = stateColors[state] || 'var(--accent)';
                
                // Dynamic limits table
                const limits = leverage.limits || {};
                document.getElementById('lev-vix').textContent = `${(leverage.vix || 20).toFixed(1)}`;
                document.getElementById('lev-vix-max').textContent = `${(limits.vix_adjusted || 2).toFixed(2)}x`;
                document.getElementById('lev-drawdown').textContent = `${(leverage.drawdown_pct || 0).toFixed(2)}%`;
                document.getElementById('lev-dd-max').textContent = `${(limits.drawdown_adjusted || 2).toFixed(2)}x`;
                document.getElementById('lev-buying-power').textContent = formatCurrency(leverage.buying_power || 0);
                document.getElementById('lev-daily-pnl').textContent = `${(leverage.daily_pnl_pct || 0) >= 0 ? '+' : ''}${(leverage.daily_pnl_pct || 0).toFixed(2)}%`;
                
                // Kill switch
                const killSection = document.getElementById('kill-switch-section');
                if (leverage.kill_switch_active) {
                    killSection.style.display = 'block';
                    document.getElementById('kill-switch-reason').textContent = leverage.kill_switch_reason || 'Activated';
                } else {
                    killSection.style.display = 'none';
                }
                
            } catch (e) {
                console.error('Error loading leverage status:', e);
            }
        }
        
        async function toggleKillSwitch() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to activate the emergency kill switch? This will restrict leverage for 24 hours.')) {
                return;
            }
            
            try {
                const res = await fetch('/api/leverage/kill-switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activate: true, reason: 'Manual activation from UI' })
                });
                
                if (res.ok) {
                    showToast('warning', 'Kill Switch Activated', 'Leverage has been restricted for 24 hours');
                    loadLeverageStatus();
                } else {
                    showToast('error', 'Failed', 'Could not activate kill switch');
                }
            } catch (e) {
                showToast('error', 'Error', e.message);
            }
        }
        
        // ========== CONNECTION STATUS ==========
        let connectionLost = false;
        
        async function checkConnection() {
            try {
                const res = await fetch('/api/health', { method: 'GET', cache: 'no-store' });
                if (res.ok) {
                    if (connectionLost) {
                        showToast('success', 'Reconnected', 'Connection restored');
                        connectionLost = false;
                    }
                    document.getElementById('connection-status').classList.remove('offline');
                    document.getElementById('connection-status').querySelector('span').textContent = 'Connected';
                }
            } catch (e) {
                if (!connectionLost) {
                    showToast('warning', 'Connection Lost', 'Attempting to reconnect...');
                    connectionLost = true;
                }
                document.getElementById('connection-status').classList.add('offline');
                document.getElementById('connection-status').querySelector('span').textContent = 'Offline';
            }
        }
        
        // Check connection every 30 seconds
        setInterval(checkConnection, 30000);
        
        // ========== ENHANCED PORTFOLIO LOAD ==========
        const originalLoadPortfolio = loadPortfolio;
        loadPortfolio = async function() {
            await originalLoadPortfolio();
            
            // Update quick stats after portfolio loads
            loadQuickStats();
        };
        
        // ========== SHOW TOAST ON ACTIONS ==========
        const originalRunRebalance = runRebalance;
        runRebalance = async function() {
            showToast('info', 'Rebalancing Started', 'Running portfolio optimization...');
            try {
                await originalRunRebalance();
            } catch (e) {
                showToast('error', 'Rebalance Failed', e.message || 'Check console for details');
                throw e;
            }
        };
        
        const originalCancelOrders = cancelOrders;
        cancelOrders = async function() {
            try {
                await originalCancelOrders();
                showToast('success', 'Orders Cancelled', 'All pending orders have been cancelled');
            } catch (e) {
                showToast('error', 'Cancel Failed', e.message || 'Could not cancel orders');
            }
        };
        
        // ========== MINI PERFORMANCE CHART ==========
        function renderMiniChart(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container || !data || data.length < 2) return;
            
            const width = container.offsetWidth;
            const height = 60;
            const padding = 2;
            
            const minVal = Math.min(...data);
            const maxVal = Math.max(...data);
            const range = maxVal - minVal || 1;
            
            const points = data.map((val, i) => {
                const x = padding + (i / (data.length - 1)) * (width - padding * 2);
                const y = height - padding - ((val - minVal) / range) * (height - padding * 2);
                return `${x},${y}`;
            }).join(' ');
            
            const lastY = height - padding - ((data[data.length - 1] - minVal) / range) * (height - padding * 2);
            const isPositive = data[data.length - 1] >= data[0];
            const strokeColor = isPositive ? 'var(--success)' : 'var(--danger)';
            const fillColor = isPositive ? 'rgba(0, 245, 147, 0.2)' : 'rgba(255, 71, 87, 0.2)';
            
            container.innerHTML = `
                <svg width="${width}" height="${height}">
                    <defs>
                        <linearGradient id="chartGradient-${containerId}" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:${strokeColor};stop-opacity:0.3"/>
                            <stop offset="100%" style="stop-color:${strokeColor};stop-opacity:0"/>
                        </linearGradient>
                    </defs>
                    <polygon points="${padding},${height - padding} ${points} ${width - padding},${height - padding}" fill="url(#chartGradient-${containerId})"/>
                    <polyline points="${points}" fill="none" stroke="${strokeColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="${width - padding}" cy="${lastY}" r="3" fill="${strokeColor}"/>
                </svg>
            `;
        }
        
        // Initial load of quick stats
        setTimeout(loadQuickStats, 2000);
        
        // Welcome toast
        setTimeout(() => {
            showToast('info', 'Welcome', 'Press ? for keyboard shortcuts', 4000);
        }, 3000);
        
        // ========== SETTINGS ==========
        function setTheme(theme) {
            const root = document.documentElement;
            
            // Reset all theme buttons
            document.querySelectorAll('[id^="theme-"]').forEach(btn => btn.classList.remove('primary'));
            document.getElementById(`theme-${theme}`).classList.add('primary');
            
            if (theme === 'midnight') {
                root.style.setProperty('--bg-primary', '#050510');
                root.style.setProperty('--bg-secondary', '#0a0a1a');
                root.style.setProperty('--bg-card', '#10102a');
                root.style.setProperty('--accent', '#6366f1');
            } else {
                root.style.setProperty('--bg-primary', '#0a0a0f');
                root.style.setProperty('--bg-secondary', '#12121a');
                root.style.setProperty('--bg-card', '#16161f');
                root.style.setProperty('--accent', '#00e5ff');
            }
            
            localStorage.setItem('theme', theme);
        }
        
        function updateRefreshInterval(value) {
            document.getElementById('refresh-interval-label').textContent = value + 's';
            localStorage.setItem('refreshInterval', value);
        }
        
        function saveSettings() {
            const settings = {
                soundAlerts: document.getElementById('sound-alerts').checked,
                toastAlerts: document.getElementById('toast-alerts').checked,
                showPnlBars: document.getElementById('show-pnl-bars').checked,
                compactView: document.getElementById('compact-view').checked,
                refreshInterval: document.getElementById('refresh-interval').value
            };
            
            localStorage.setItem('settings', JSON.stringify(settings));
            showToast('success', 'Settings Saved', 'Your preferences have been saved');
        }
        
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('settings') || '{}');
                const theme = localStorage.getItem('theme') || 'dark';
                
                if (theme) setTheme(theme);
                if (settings.soundAlerts !== undefined) document.getElementById('sound-alerts').checked = settings.soundAlerts;
                if (settings.toastAlerts !== undefined) document.getElementById('toast-alerts').checked = settings.toastAlerts;
                if (settings.showPnlBars !== undefined) document.getElementById('show-pnl-bars').checked = settings.showPnlBars;
                if (settings.compactView !== undefined) document.getElementById('compact-view').checked = settings.compactView;
                if (settings.refreshInterval) {
                    document.getElementById('refresh-interval').value = settings.refreshInterval;
                    document.getElementById('refresh-interval-label').textContent = settings.refreshInterval + 's';
                }
                
                if (settings.compactView) {
                    document.body.classList.add('compact-view');
                }
            } catch (e) {
                console.log('Could not load settings');
            }
        }
        
        // ========== EXPORT FUNCTIONS ==========
        function exportPositions() {
            if (!allPositions.length) {
                showToast('warning', 'No Data', 'No positions to export');
                return;
            }
            
            const headers = ['Symbol', 'Qty', 'Avg Cost', 'Current', 'Value', 'P/L', 'P/L %'];
            const rows = allPositions.map(p => [
                p.symbol,
                p.qty,
                p.avg_entry_price,
                p.current_price,
                p.market_value,
                p.unrealized_pl,
                (p.unrealized_plpc * 100).toFixed(2)
            ]);
            
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            downloadCSV(csv, 'positions_' + new Date().toISOString().split('T')[0] + '.csv');
            showToast('success', 'Exported', 'Positions exported to CSV');
        }
        
        async function exportTrades() {
            try {
                const res = await fetch('/api/trade-history');
                const data = await res.json();
                
                if (!data.trades || !data.trades.length) {
                    showToast('warning', 'No Data', 'No trades to export');
                    return;
                }
                
                const headers = ['Timestamp', 'Symbol', 'Side', 'Qty', 'Price', 'Notional', 'P/L'];
                const rows = data.trades.map(t => [
                    t.timestamp,
                    t.symbol,
                    t.side,
                    t.qty,
                    t.price,
                    t.notional,
                    t.pnl || ''
                ]);
                
                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                downloadCSV(csv, 'trades_' + new Date().toISOString().split('T')[0] + '.csv');
                showToast('success', 'Exported', 'Trades exported to CSV');
            } catch (e) {
                showToast('error', 'Export Failed', e.message);
            }
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Load settings on init
        loadSettings();
    </script>
</body>
</html>
